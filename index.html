<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Negocios RD ‚Äì Buscador RD (v10)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    :root{ --bg:#f6f8fc; --card:#ffffff; --muted:#64748b; --text:#0b1220; --primary:#14b8a6; --border:#e5e9f2; --chip:#eef2f7; }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#f6f8fc 0%, #eef2f7 100%); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:16px;}
    .title{display:flex; align-items:center; gap:10px; margin:0 0 10px; }
    .badge{background:var(--chip); color:#475569; border:1px solid #e2e8f0; padding:3px 8px; border-radius:999px; font-size:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 6px 16px rgba(15,23,42,.06);}
    .muted{color:var(--muted); font-size:12px;}
    .grid{display:grid; gap:8px;}
    .grid-4{grid-template-columns: repeat(4, minmax(0, 1fr));}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    select,input[type="text"],button{width:100%; padding:10px; border-radius:12px; border:1px solid #d7dde8; background:#fff; color:#0b1220; outline:none;}
    button{cursor:pointer; font-weight:600;}
    .btn{border:1px solid #dbe1ea; background:#ffffff;}
    .btn-primary{background: linear-gradient(135deg, #10b981, #14b8a6); border:0; color:#ffffff;}
    .btn-ghost{background:transparent; border:1px dashed #cbd5e1; color:#334155;}
    #map{width:100%; height:64vh; border-radius:14px; border:1px solid #dbe1ea; background:#eef2f7;}
    .table-wrap{max-height:60vh; overflow:auto; border-radius:12px; border:1px solid var(--border);}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th, td{padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:top;}
    th{position:sticky; top:0; background:#f4f7fb; color:#64748b; z-index:1;}
    .errbar,.okbar{position:fixed; left:8px; right:8px; bottom:8px; padding:8px 10px; border-radius:12px; display:none;}
    .errbar{background:#fde8e8; border:1px solid #f8b4b4; color:#7f1d1d;}
    .okbar{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;}
    .progress{height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid #e5e9f2;}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg,#10b981,#14b8a6); transition:width .25s;}
    .hint{font-size:12px; color:#64748b;}
    .link{color:#0ea5e9; text-decoration:none}
    .link:hover{text-decoration:underline}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .switch{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#334155}
    .switch input{vertical-align:middle}
    textarea{width:100%; min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:#0b1220; color:#e8eef9; border-radius:10px; border:1px solid #1f2937; padding:8px; display:none;}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h2 style="margin:0">Negocios RD</h2>
      <span class="badge">OSM + Overpass</span>
      <span class="badge">Single-file</span>
      <span class="badge">Listo para GitHub Pages</span>
    </div>

    <div class="card">
      <div class="grid grid-4">
        <div>
          <label class="muted">Tipo de negocio (buscador)</label>
          <input id="qTipo" type="text" placeholder="Ej.: ferreter√≠a, papeler√≠a, farmacia, colegios..." />
        </div>
        <div>
          <label class="muted">Provincia</label>
          <select id="selProv"></select>
        </div>
        <div>
          <label class="muted">Municipio (opcional)</label>
          <select id="selMuni"><option value="">(todos)</option></select>
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button id="btnBuscar" class="btn btn-primary" style="flex:1">üîé Buscar</button>
          <button id="btnCSV" class="btn" style="flex:1">‚¨á CSV</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="progress" style="flex:1; min-width:160px;"><div id="pbar"></div></div>
        <span id="status" class="hint">Listo</span>
        <button id="btnCargarMunicipios" class="btn">‚Üª Cargar municipios</button>
        <label class="switch"><input type="checkbox" id="cbCluster" checked> Clustering</label>
        <label class="switch"><input type="checkbox" id="cbRapido"> Modo r√°pido</label>
        <button id="btnShare" class="btn">üîó Copiar enlace</button>
        <button id="btnVerQL" class="btn">üëÄ Ver consulta</button>
        <button id="btnDemo" class="btn btn-ghost">‚ú® Demo</button>
      </div>
      <div class="hint" style="margin-top:6px;">Tip: si ‚ÄúMunicipio‚Äù tarda, d√©jalo vac√≠o y busca por provincia (m√°s r√°pido). El modo r√°pido limita la cantidad devuelta para responder antes.</div>
      <textarea id="ql"></textarea>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:10px;">
      <div class="card">
        <div id="map"></div>
        <div id="hintZero" class="hint" style="margin-top:6px; display:none;">Sin resultados para el √°rea seleccionada.</div>
      </div>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between; margin-bottom:6px;">
          <div class="badge">Resultados: <span id="statCount">0</span></div>
          <div class="badge">Fuente: OpenStreetMap (cobertura variable)</div>
        </div>
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Nombre</th><th>Tipo</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Web</th><th>Lat</th><th>Lon</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="err" class="errbar"></div>
  <div id="ok" class="okbar"></div>

<script>
const PROVINCIAS = [
  "Azua","Bahoruco","Barahona","Dajab√≥n","Distrito Nacional","Duarte","El Seibo","El√≠as Pi√±a","Espaillat",
  "Hato Mayor","Hermanas Mirabal","Independencia","La Altagracia","La Romana","La Vega","Mar√≠a Trinidad S√°nchez",
  "Monse√±or Nouel","Monte Cristi","Monte Plata","Pedernales","Peravia","Puerto Plata","Saman√°","San Crist√≥bal",
  "San Jos√© de Ocoa","San Juan","San Pedro de Macor√≠s","S√°nchez Ram√≠rez","Santiago","Santiago Rodr√≠guez",
  "Santo Domingo","Valverde"
];

const STATE = { map:null, cluster:null, markers:[], features:[], municipiosCache:{}, lastQueryText:'' };

function showErr(msg){const el=document.getElementById('err'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 5200);}
function showOk(msg){const el=document.getElementById('ok'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200);}
function setStatus(text, p=null){ document.getElementById('status').textContent=text; if(p!=null){ document.getElementById('pbar').style.width = Math.max(0, Math.min(100, p)) + '%'; } }
function setBusy(b){ document.querySelectorAll('button, select, input').forEach(el=> el.disabled = !!b ); }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n'))?('\"'+s.replace(/\"/g,'\"\"')+'\"'):s; }
function toCSV(rows, headers){ const head=headers.map(csvEscape).join(','); const body=rows.map(r=>headers.map(h=>csvEscape(r[h])).join(',')).join('\\n'); return head+'\\n'+body; }
function uniq(arr){return Array.from(new Set(arr))}
function norm(s){return (s??'').toString().trim().toLowerCase();}
function stripAccents(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function escapeRegex(s){ return (s||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 75% 52%)`; }
function svgPin(color){ const fill=color||'#3b82f6'; const stroke='#0b1220'; const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38"><path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/><circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }

function initMap(){ if(STATE.map) return; const RD=[18.735693,-70.162651]; STATE.map=L.map('map',{zoomControl:true}).setView(RD,8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map); window.addEventListener('resize', ()=>STATE.map&&STATE.map.invalidateSize()); }
function clearMarkers(){ if(STATE.cluster){ STATE.cluster.clearLayers(); } STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function ensureCluster(){ if(!STATE.cluster){ STATE.cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 }); STATE.map.addLayer(STATE.cluster); } }

function addMarker(lat, lon, props){
  const color=hashColor(props.tipo||'negocio');
  const marker=L.marker([lat,lon],{icon: L.icon({iconUrl: svgPin(color), iconSize:[26,38], iconAnchor:[13,36], popupAnchor:[0,-30]})});
  let addr = [props.address, props.city, props.state].filter(Boolean).join(', ');
  const phone = props.phone ? `<div>Tel: ${props.phone}</div>` : '';
  const web = props.website ? `<div>Web: <a class="link" href="${props.website}" target="_blank" rel="noopener">${props.website}</a></div>` : '';
  marker.bindPopup(`<strong>${props.name||'(sin nombre)'}</strong><div class="muted">${props.tipo||''}</div><div>${addr||''}</div>${phone}${web}`);
  STATE.markers.push(marker);
  const useCluster = document.getElementById('cbCluster').checked;
  if(useCluster){ ensureCluster(); STATE.cluster.addLayer(marker); } else { marker.addTo(STATE.map); }
}

const OVERPASS_SERVERS = [
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.fr/api/interpreter"
];

const KEYMAP = {
  'colegio': [{k:'amenity',v:'school'}], 'colegios': [{k:'amenity',v:'school'}],
  'escuela': [{k:'amenity',v:'school'}], 'escuelas': [{k:'amenity',v:'school'}],
  'universidad': [{k:'amenity',v:'university'}], 'universidades': [{k:'amenity',v:'university'}],
  'instituto': [{k:'amenity',v:'college'}], 'liceo': [{k:'amenity',v:'school'}],
  'hospital': [{k:'amenity',v:'hospital'}], 'cl√≠nica': [{k:'amenity',v:'clinic'}], 'clinica': [{k:'amenity',v:'clinic'}],
  'farmacia': [{k:'amenity',v:'pharmacy'}, {k:'shop',v:'chemist'}],
  'supermercado': [{k:'shop',v:'supermarket'}], 'supermercados': [{k:'shop',v:'supermarket'}],
  'colmado': [{k:'shop',v:'convenience'}], 'colmadon': [{k:'shop',v:'convenience'}],
  'panaderia': [{k:'shop',v:'bakery'}], 'panader√≠a': [{k:'shop',v:'bakery'}],
  'restaurante': [{k:'amenity',v:'restaurant'}], 'pizzeria': [{k:'amenity',v:'restaurant'}], 'pizzer√≠a': [{k:'amenity',v:'restaurant'}],
  'cafe': [{k:'amenity',v:'cafe'}], 'cafeteria': [{k:'amenity',v:'cafe'}], 'cafeter√≠a': [{k:'amenity',v:'cafe'}],
  'ferreteria': [{k:'shop',v:'hardware'}, {k:'shop',v:'doityourself'}, {k:'shop',v:'construction_supplies'}], 'ferreter√≠a': [{k:'shop',v:'hardware'},{k:'shop',v:'doityourself'},{k:'shop',v:'construction_supplies'}],
  'papeleria': [{k:'shop',v:'stationery'}, {k:'shop',v:'office_supplies'}], 'papeler√≠a': [{k:'shop',v:'stationery'}, {k:'shop',v:'office_supplies'}],
  'libreria': [{k:'shop',v:'books'}], 'librer√≠a': [{k:'shop',v:'books'}],
  'electrodomesticos': [{k:'shop',v:'electronics'}], 'electrodom√©sticos': [{k:'shop',v:'electronics'}],
  'ropa': [{k:'shop',v:'clothes'}], 'zapateria': [{k:'shop',v:'shoes'}], 'zapater√≠a': [{k:'shop',v:'shoes'}],
  'muebles': [{k:'shop',v:'furniture'}],
  'taller': [{k:'shop',v:'car_repair'}], 'repuestos': [{k:'shop',v:'car_parts'}],
  'gomeria': [{k:'shop',v:'tyres'}], 'gomera': [{k:'shop',v:'tyres'}], 'gomer√≠a': [{k:'shop',v:'tyres'}],
  'banco': [{k:'amenity',v:'bank'}], 'atm': [{k:'amenity',v:'atm'}],
  'hotel': [{k:'tourism',v:'hotel'}], 'hostal': [{k:'tourism',v:'hostel'}], 'hospedaje': [{k:'tourism',v:'guest_house'}],
  'veterinaria': [{k:'amenity',v:'veterinary'}],
};

function keyToTags(q){
  const k = stripAccents(norm(q));
  if(KEYMAP[k]) return KEYMAP[k];
  if(k.endswith && k.endsWith('s') && KEYMAP[k.slice(0,-1)]) return KEYMAP[k.slice(0,-1)];
  return null;
}

function qlHeader(){ return "[out:json][timeout:30];"; }

function qlBusqueda(prov, muni){
  const provRx = escapeRegex(prov);
  const muniRx = muni ? escapeRegex(muni) : null;
  let q = `${qlHeader()}
area["ISO3166-1"="DO"]->.country;
rel(area.country)["boundary"="administrative"]["admin_level"~"^(4|6)$"]["name"~"^${provRx}$", i]->.prov;
area(.prov)->.provA;`;
  if(muniRx){
    q += `
rel(area.provA)["boundary"="administrative"]["admin_level"~"^(6|7|8)$"]["name"~"^${muniRx}$", i]->.muni;
area(.muni)->.a;`;
  }else{
    q += `
(.provA;)->.a;`;
  }
  return q;
}

function buildQueryByName(q, prov, muni, modoRapido){
  const tags = keyToTags(q);
  const limit = modoRapido ? ' 300' : '';
  let body = qlBusqueda(prov, muni);
  if(tags){
    const parts = tags.map(t => `node(area.a)["${t.k}"="${t.v}"]; way(area.a)["${t.k}"="${t.v}"]; relation(area.a)["${t.k}"="${t.v}"];`).join('\n');
    body += `(${parts})out center${limit};`;
  }else{
    const r = escapeRegex(q.trim());
    body += `(
      node(area.a)["name"~"${r}", i];
      way(area.a)["name"~"${r}", i];
      relation(area.a)["name"~"${r}", i];
      node(area.a)["shop"~"${r}", i];
      way(area.a)["shop"~"${r}", i];
      relation(area.a)["shop"~"${r}", i];
      node(area.a)["amenity"~"${r}", i];
      way(area.a)["amenity"~"${r}", i];
      relation(area.a)["amenity"~"${r}", i];
    )out center${limit};`;
  }
  STATE.lastQueryText = body;
  return body;
}

function buildQueryBBox(q, bbox, modoRapido){
  const [s,w,n,e] = bbox;
  const tags = keyToTags(q);
  const limit = modoRapido ? ' 300' : '';
  let body;
  if(tags){
    const parts = tags.map(t => `node["${t.k}"="${t.v}"](${s},${w},${n},${e}); way["${t.k}"="${t.v}"](${s},${w},${n},${e}); relation["${t.k}"="${t.v}"](${s},${w},${n},${e});`).join('\n');
    body = `(${parts})out center${limit};`;
  }else{
    const r = escapeRegex(q.trim());
    body = `(
      node["name"~"${r}", i](${s},${w},${n},${e});
      way["name"~"${r}", i](${s},${w},${n},${e});
      relation["name"~"${r}", i](${s},${w},${n},${e});
      node["shop"~"${r}", i](${s},${w},${n},${e});
      way["shop"~"${r}", i](${s},${w},${n},${e});
      relation["shop"~"${r}", i](${s},${w},${n},${e});
      node["amenity"~"${r}", i](${s},${w},${n},${e});
      way["amenity"~"${r}", i](${s},${w},${n},${e});
      relation["amenity"~"${r}", i](${s},${w},${n},${e});
    )out center${limit};`;
  }
  STATE.lastQueryText = "[out:json][timeout:30];\n" + body;
  return STATE.lastQueryText;
}

async function overpassFetch(query){
  const servers = OVERPASS_SERVERS.slice();
  let lastErr = null;
  for(const base of servers){
    try{
      const body = "data=" + encodeURIComponent(query);
      const r = await fetch(base, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}, body});
      if(r.ok){ return await r.json(); }
      const r2 = await fetch(base + "?data=" + encodeURIComponent(query));
      if(r2.ok){ return await r2.json(); }
      lastErr = new Error("HTTP "+r.status);
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('Overpass error');
}

async function nominatimBBox(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=do&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, {headers: {'Accept':'application/json'}});
  if(!r.ok) throw new Error('Nominatim '+r.status);
  const arr = await r.json();
  if(!arr.length || !arr[0].boundingbox) throw new Error('Sin bbox');
  const bb = arr[0].boundingbox;
  return [parseFloat(bb[0]), parseFloat(bb[2]), parseFloat(bb[1]), parseFloat(bb[3])];
}

function buildMunicipiosQuery(prov){
  const provRx = escapeRegex(prov);
  const q = `${qlHeader()}
area["ISO3166-1"="DO"]->.country;
rel(area.country)["boundary"="administrative"]["admin_level"~"^(4|6)$"]["name"~"^${provRx}$", i]->.prov;
area(.prov)->.provA;
(
  rel(area.provA)["boundary"="administrative"]["admin_level"~"^(6|7|8)$"]["name"];
  node(area.provA)["place"~"city|town|village"]["name"];
);
out center;`;
  STATE.lastQueryText = q;
  return q;
}

async function cargarMunicipios(){
  const prov = document.getElementById('selProv').value;
  if(!prov){ showErr('Primero seleccione una provincia.'); return; }
  if(STATE.municipiosCache[prov]){ llenarMunicipios(STATE.municipiosCache[prov]); showOk('Municipios desde cach√©'); return; }
  setStatus('Buscando municipios‚Ä¶', 12); setBusy(true);
  try{
    const q = buildMunicipiosQuery(prov);
    document.getElementById('ql').value = STATE.lastQueryText;
    const data = await overpassFetch(q);
    const names = uniq((data.elements||[]).map(e => e.tags && e.tags.name).filter(Boolean));
    names.sort((a,b)=> String(a).localeCompare(String(b),'es',{numeric:true}));
    STATE.municipiosCache[prov] = names;
    llenarMunicipios(names);
    setStatus('Municipios cargados', 100); showOk('Municipios actualizados');
  }catch(e){
    console.error(e); showErr('No se pudieron cargar municipios (Overpass). Pruebe buscar por provincia).');
    setStatus('Error al cargar municipios', 0);
  }finally{
    setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 600);
    setBusy(false);
  }
}

function llenarMunicipios(names){
  const sel = document.getElementById('selMuni');
  sel.innerHTML = '<option value="">(todos)</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
}

async function buscar(internal=false){
  initMap();
  const q = document.getElementById('qTipo').value.trim();
  const prov = document.getElementById('selProv').value;
  const muni = document.getElementById('selMuni').value || null;
  const modoRapido = document.getElementById('cbRapido').checked;
  if(!q){ showErr('Escriba el tipo de negocio a buscar.'); return; }
  if(!prov){ showErr('Seleccione una provincia.'); return; }

  setStatus('Consultando Overpass‚Ä¶', 25); setBusy(true);
  clearMarkers(); document.querySelector('#tbl tbody').innerHTML = ''; STATE.features = [];

  try{
    const query = buildQueryByName(q, prov, muni, modoRapido);
    document.getElementById('ql').value = STATE.lastQueryText;
    const data = await overpassFetch(query);
    if(!(data.elements && data.elements.length)){
      const bbox = await nominatimBBox( (muni? `${muni}, ${prov}` : prov) + ', Dominican Republic' );
      const qbbox = buildQueryBBox(q, bbox, modoRapido);
      document.getElementById('ql').value = qbbox;
      const data2 = await overpassFetch(qbbox);
      procesarResultados(data2);
    }else{
      procesarResultados(data);
    }
  }catch(e){
    console.error(e); showErr('Error Overpass: '+(e.message||e));
  }

  renderResults();
  if(STATE.features.length){ setStatus('Completado', 100); showOk(`Cargados ${STATE.features.length} elementos.`); }
  else{ setStatus('Sin resultados', 100); showErr('Sin datos en OSM para ese t√©rmino/√°rea. Prueba otro t√©rmino o provincia.'); }
  setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 800);
  if(!internal) actualizarURL();
  setBusy(false);
}

function procesarResultados(data){
  const elements = (data && data.elements) ? data.elements : [];
  elements.forEach(el => {
    const lat = el.lat || (el.center && el.center.lat);
    const lon = el.lon || (el.center && el.center.lon);
    if(lat==null || lon==null) return;
    const t = el.tags || {};
    const tipo = t.shop || t.amenity || t.tourism || t.office || '';
    const feature = {
      name: t.name || '',
      tipo: tipo,
      address: [t['addr:street'], t['addr:housenumber']].filter(Boolean).join(' ') || t['addr:full'] || '',
      city: t['addr:city'] || t['is_in:city'] || '',
      state: t['addr:state'] || '',
      phone: t['phone'] || t['contact:phone'] || '',
      website: t['website'] || t['contact:website'] || '',
      lat: +lat, lon: +lon
    };
    STATE.features.push(feature);
  });
  return elements.length > 0;
}

function renderResults(){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  let bounds = [];
  const useCluster = document.getElementById('cbCluster').checked;
  if(useCluster) ensureCluster(); else if(STATE.cluster){ STATE.cluster.clearLayers(); }
  STATE.features.forEach((f) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${f.name||''}</td>
      <td>${f.tipo||''}</td>
      <td>${[f.address,f.city,f.state].filter(Boolean).join(', ')}</td>
      <td>${f.phone||''}</td>
      <td>${f.website?`<a class="link" href="${f.website}" target="_blank" rel="noopener">link</a>`:''}</td>
      <td>${f.lat.toFixed(6)}</td>
      <td>${f.lon.toFixed(6)}</td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=>{ STATE.map.setView([f.lat, f.lon], 17); });
    tb.appendChild(tr);
    addMarker(f.lat, f.lon, f);
    bounds.push([f.lat, f.lon]);
  });
  document.getElementById('statCount').textContent = STATE.features.length;
  document.getElementById('hintZero').style.display = STATE.features.length ? 'none' : 'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); }
}

function exportCSV(){
  if(!STATE.features.length){ showErr('No hay resultados para exportar.'); return; }
  const headers = ['name','tipo','address','city','state','phone','website','lat','lon'];
  const csv = toCSV(STATE.features, headers);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'negocios_rd.csv'; a.click(); URL.revokeObjectURL(a.href);
}

function leerParams(){
  const u = new URL(location.href);
  return {
    tipo: u.searchParams.get('tipo') || '',
    prov: u.searchParams.get('prov') || '',
    muni: u.searchParams.get('muni') || '',
    rapido: u.searchParams.get('rapido') === '1',
    cluster: u.searchParams.get('cluster') !== '0'
  };
}
function actualizarURL(){
  const u = new URL(location.href);
  const tipo = document.getElementById('qTipo').value.trim();
  const prov = document.getElementById('selProv').value;
  const muni = document.getElementById('selMuni').value;
  const rapido = document.getElementById('cbRapido').checked ? '1' : '0';
  const cluster = document.getElementById('cbCluster').checked ? '1' : '0';
  u.searchParams.set('tipo', tipo); u.searchParams.set('prov', prov); u.searchParams.set('muni', muni); u.searchParams.set('rapido', rapido); u.searchParams.set('cluster', cluster);
  history.replaceState(null, '', u.toString());
}
function copiarEnlace(){ actualizarURL(); navigator.clipboard.writeText(location.href).then(()=> showOk('Enlace copiado')).catch(()=> showErr('No se pudo copiar el enlace.')); }

async function init(){
  initMap();
  const selP = document.getElementById('selProv');
  selP.innerHTML = '<option value="">(seleccione)</option>' + PROVINCIAS.map(p=>`<option value="${p}">${p}</option>`).join('');
  document.getElementById('btnBuscar').addEventListener('click', ()=>buscar(false));
  document.getElementById('btnCSV').addEventListener('click', exportCSV);
  document.getElementById('btnCargarMunicipios').addEventListener('click', cargarMunicipios);
  document.getElementById('btnShare').addEventListener('click', copiarEnlace);
  document.getElementById('btnVerQL').addEventListener('click', ()=>{
    const t = document.getElementById('ql'); t.style.display = (t.style.display==='none'||t.style.display==='') ? 'block' : 'none';
    if(t.style.display==='block'){ t.value = STATE.lastQueryText || '(A√∫n no generada)'; }
  });
  document.getElementById('btnDemo').addEventListener('click', async ()=>{
    document.getElementById('qTipo').value = 'farmacia';
    selP.value = 'Santo Domingo';
    document.getElementById('cbRapido').checked = true;
    await cargarMunicipios();
    buscar(false);
  });

  const p = leerParams();
  document.getElementById('qTipo').value = p.tipo || 'ferreter√≠a';
  if(p.cluster===false){ document.getElementById('cbCluster').checked = false; }
  document.getElementById('cbRapido').checked = !!p.rapido;
  if(PROVINCIAS.includes(p.prov)){ selP.value = p.prov; }
  if(selP.value){ await cargarMunicipios(); }
  const selM = document.getElementById('selMuni');
  if(p.muni){ selM.value = p.muni; }
  setStatus('Listo', 0);
  if(p.tipo && p.prov){ buscar(true); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
