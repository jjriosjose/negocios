<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Suite Operativa ¬∑ v3.6.1</title>
<style>
:root{
  --teal:#0fa7a0; --teal-700:#0c7973; --bg:#f5f7f8; --card:#fff;
  --ink:#1f2937; --muted:#64748b; --danger:#ef4444; --ok:#22c55e;
  --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:#f6fbfb;color:var(--ink);
     background-position:center top;background-repeat:no-repeat;background-size:contain;background-attachment:fixed}
header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,0.96);backdrop-filter:saturate(130%) blur(6px);border-bottom:1px solid #e8edf3}
.bar{max-width:1260px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:12px}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.brand img{height:36px;border-radius:10px;background:#fff;box-shadow:var(--shadow)}
.btn{border:0;border-radius:12px;background:var(--teal);color:#fff;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
.btn.small{padding:6px 10px;font-size:12px}
.btn.ghost{background:#fff;color:var(--teal-700);border:1px solid #dbe1ea;box-shadow:none}
.btn.danger{background:var(--danger)} .btn.ok{background:var(--ok)}
main{max-width:1260px;margin:20px auto;padding:0 14px}
.view{display:none}.view.active{display:block}
.grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
.tile{background:var(--card);border:1px solid #eef2f7;border-radius:18px;padding:18px;min-height:152px;display:flex;flex-direction:column;gap:8px;text-decoration:none;color:inherit;box-shadow:var(--shadow)}
.tile strong{font-size:18px}
.kpi{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
.kpi .card{background:var(--card);border:1px solid #eef2f7;border-radius:14px;padding:14px 16px;min-width:220px;box-shadow:var(--shadow)}
.kpi .label{font-size:12px;color:var(--muted)} .kpi .value{font-size:22px;font-weight:900;margin-top:4px}
.section{background:var(--card);border:1px solid #eef2f7;border-radius:18px;box-shadow:var(--shadow);padding:14px;margin:14px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 240px}
input[type="text"],input[type="date"],input[type="color"],select,textarea{width:100%;padding:10px;border:1px solid #dbe1ea;border-radius:10px;background:#fff}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px;border-bottom:1px solid #eef2f7;font-size:14px}
.badge{padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}.pill{background:#eef9f8;color:#0c7973;padding:6px 8px;border-radius:999px;font-size:12px}
.canvas-wrap{position:relative;height:70vh;border:1px solid #e5e7eb;border-radius:14px;background:#fff;overflow:hidden}
.stage{position:absolute;left:0;top:0;transform-origin:0 0}
.stage img{display:block;max-width:none;user-select:none;pointer-events:none}
.svg-layer{position:absolute;left:0;top:0;pointer-events:auto}
.zoombar{position:absolute;right:10px;top:10px;display:flex;flex-direction:column;gap:6px}
.zone-selected{filter:drop-shadow(0 0 .35rem rgba(8,145,178,.45))}
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.print-header{display:none}
@media print{
 header,.no-print,.zoombar,.toolbar,.create-form{display:none !important}
 .print-header{display:flex;gap:8px;align-items:center;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #e5e7eb}
 .print-header img{height:40px;border-radius:8px}
 .section{border:0;box-shadow:none;margin:0;padding:0}
}
.muted{color:#64748b}
footer{color:#8a98a9;font-size:12px;text-align:center;margin:30px 0}

@media print{
  .no-print{display:none!important}
  .canvas-wrap{height:auto!important; overflow:visible!important; margin:0 auto; border:0}
  .stage{position:relative!important}
  header, footer{display:none!important}
}


@media print{
  #qrOverlay{display:block!important; position:absolute; right:12px; bottom:12px;}
}

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand"><img id="brandLogo" alt="Logo"><div>Suite Operativa</div></div>
    <div style="flex:1"></div>
    <button id="btnMenu" class="btn ghost small">Men√∫</button>
    <button id="btnAjustes" class="btn small">Ajustes</button>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="view active">
    <div class="kpi">
      <div class="card"><div class="label">Tareas activas</div><div class="value" id="kpiActivas">0</div></div>
      <div class="card"><div class="label">Tareas completadas</div><div class="value" id="kpiCompletadas">0</div></div>
      <div class="card"><div class="label">Vencidas</div><div class="value" id="kpiVencidas">0</div></div>
      <div class="card"><div class="label">Cumplimiento</div><div class="value" id="kpiCumplimiento">0%</div></div>
    </div>
    <div class="grid">
      <a class="tile" data-route="planos"><strong>üó∫Ô∏è Planos y zonas</strong><span class="muted">Dibuja y edita zonas.</span></a>
      <a class="tile" data-route="personal"><strong>üë∑‚Äç‚ôÇÔ∏è Personal</strong><span class="muted">Colaboradores y roles.</span></a>
      <a class="tile" data-route="agendas"><strong>üìÖ Agendas</strong><span class="muted">Planificaci√≥n.</span></a>
      <a class="tile" data-route="tareas"><strong>‚úÖ Tareas</strong><span class="muted">Reportes e impresi√≥n.</span></a>
      <a class="tile" data-route="indicadores"><strong>üìä Indicadores</strong><span class="muted">Gr√°ficas din√°micas.</span></a>
      <a class="tile" data-route="io"><strong>üíæ Importar / Exportar</strong><span class="muted">Excel & reinicio.</span></a>
      <a class="tile" data-route="ajustes"><strong>‚öôÔ∏è Ajustes</strong></a>
      <a class="tile" data-route="ayuda"><strong>üß≠ Ayuda</strong></a>
    </div>
  </section>

  <!-- PLANOS -->
  <section id="view-planos" class="view">
    <h2>Planos y zonas de trabajo</h2>
    
    <div class="print-header" id="printHeaderPlanos">
      <img id="printLogoPlanos"><div><strong>Planos y zonas de trabajo</strong><div id="printMetaPlanos" style="font-size:12px;color:#64748b"></div></div>
    </div>
<div class="section">
      <div class="toolbar">
        <label class="pill">Plano: <input type="file" id="filePlano" accept="image/*"></label>
        <button class="btn small" id="btnPlanoReset">Usar plano en blanco</button>
        <span class="pill">Zona: <input type="text" id="zonaNombre" placeholder="Nombre" style="width:160px"></span>
        <span class="pill">Color: <input type="color" id="zonaColor" value="#0fa7a0"></span>
        <span class="pill">Herramienta
          <select id="toolKind">
            <option value="poly">Pol√≠gono</option>
            <option value="rect">Rect√°ngulo</option>
            <option value="ellipse">Elipse</option>
          </select>
        </span>
        <button class="btn small" id="btnIniciar">Iniciar</button>
        <button class="btn small" id="btnFinalizar">Finalizar</button>
        <div style="flex:1"></div>
        <button class="btn ghost small" id="btnPrintPlano">Imprimir plano</button>
        <button class="btn ghost small" id="btnXlsPlano">Exportar XLS</button>
        
        <button class="btn ghost small" id="btnInsertQR">Insertar QR</button>

      </div>
      <div class="canvas-wrap" id="canvasWrap">
        <div class="stage" id="stage">
          <img id="planoImg" alt="Plano">
          <svg id="svgLayer" class="svg-layer"></svg>
        
        <div id="qrOverlay" class="no-print" style="position:absolute; right:12px; bottom:12px; cursor:move; display:none;">
          <img id="qrImg" alt="QR" style="width:140px;height:140px;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,.15);background:#fff;padding:8px;">
          <div style="text-align:center;font-size:12px;color:#1f2937;background:#fff;padding:2px 6px;border-radius:6px;margin-top:4px;box-shadow:0 2px 8px rgba(0,0,0,.08)">Ver reporte</div>
        </div>

        <div class="zoombar no-print">
          <button class="btn small" id="btnZoomIn">+</button>
          <button class="btn small" id="btnZoomOut">‚àí</button>
          <button class="btn small" id="btnZoomFit">Ajustar</button>
        </div>
      </div>
      <div class="legend" id="legend"></div>
    </div>
    <div class="section">
      <h3>Zonas registradas</h3>
      <div id="zonasList" class="muted">A√∫n no hay zonas.</div>
    </div>
  </section>

  <!-- PERSONAL -->
  <section id="view-personal" class="view">
    <h2>Gesti√≥n de personal</h2>
    <div class="section">
      <div class="row">
        <div class="col">
          <h3>Nuevo colaborador</h3>
          <label>Nombre<input id="pNombre" placeholder="Nombre"></label>
          <label>Cargo<input id="pCargo" placeholder="Cargo"></label>
          <label>Tel√©fono<input id="pTel" placeholder="Tel√©fono"></label>
          <button class="btn" id="btnAddPers">Agregar</button>
        </div>
        <div class="col">
          <h3>Listado</h3>
          <table id="tblPersonal"><thead><tr><th>Nombre</th><th>Cargo</th><th>Tel√©fono</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- AGENDAS -->
  <section id="view-agendas" class="view">
    <h2>Agendas</h2>
    <div class="section create-form no-print">
      <div class="row">
        <div class="col"><label>Responsable<select id="aResp"></select></label></div>
        <div class="col"><label>Fecha<input type="date" id="aFecha"></label></div>
        <div class="col"><label>Estado<select id="aEstado"><option value="pendiente">Pendiente</option><option value="completado">Completado</option></select></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Descripci√≥n<textarea id="aDesc" placeholder="Detalle del evento"></textarea></label></div>
        <div class="col" style="align-self:end"><button class="btn" id="btnAddAgenda">Agregar a agenda</button></div>
      </div>
    </div>
    <div class="section">
      <h3>Agenda semanal</h3>
      <table id="tblAgenda"><thead><tr><th>Fecha</th><th>Responsable</th><th>Descripci√≥n</th><th>Estado</th><th class="no-print"></th></tr></thead><tbody></tbody></table>
      <div style="text-align:right;margin-top:8px">
        <button class="btn ghost small no-print" id="btnXlsAgenda">Exportar XLS</button>
      </div>
    </div>
  </section>

  <!-- TAREAS -->
  <section id="view-tareas" class="view">
    <h2>Tareas</h2>
    <div class="section create-form no-print">
      <div class="row">
        <div class="col"><label>T√≠tulo<input id="tTitulo" type="text" placeholder="Ej. Inspecci√≥n de √°rea A"></label></div>
        <div class="col"><label>Zona<select id="tZona"></select></label></div>
        <div class="col"><label>Responsable<select id="tResp"></select></label></div>
      </div>
      <div class="row">
        <div class="col"><label>Fecha inicio<input type="date" id="tInicio"></label></div>
        <div class="col"><label>Fecha fin (si recurrente)<input type="date" id="tFin"></label></div>
        <div class="col"><label>Frecuencia
          <select id="tFreq"><option>√önica</option><option>Diaria</option><option selected>Semanal</option><option>Mensual</option></select>
        </label></div>
        <div class="col"><label>Estado
          <select id="tEstado"><option value="pendiente">Pendiente</option><option value="en_progreso">En progreso</option><option value="completada">Completada</option></select>
        </label></div>
      </div>
      <div class="row">
        <div class="col"><label>Descripci√≥n<textarea id="tDesc" placeholder="Detalles y notas"></textarea></label></div>
        <div class="col" style="align-self:end"><button class="btn" id="btnCrearTarea">Crear</button></div>
      </div>
    </div>
    <div class="section">
      <div class="row no-print">
        <div class="col"><h3>Listado de tareas</h3></div>
        <div class="col" style="text-align:right">
          <label>Responsable: <select id="fResp"></select></label>
          <label style="margin-left:10px">Semana:
            <input type="date" id="wStart"> a <input type="date" id="wEnd">
          </label>
          <button class="btn ghost small no-print" id="btnPrintSemana">Imprimir semana</button>
          <button class="btn ghost small no-print" id="btnXlsTareas">Exportar XLS</button>
        </div>
      </div>
      <div class="print-header" id="printHeader">
        <img id="printLogo"><div><strong>Reporte semanal por responsable</strong><div id="printMeta" style="font-size:12px;color:#64748b"></div></div>
      </div>
      <div class="table-wrap"><table id="tblTareas"><thead id="theadTareas"></thead><tbody></tbody></table></div>
    </div>
  </section>

  <!-- INDICADORES -->
  <section id="view-indicadores" class="view">
    <h2>Indicadores</h2>
    <div class="section no-print">
      <div class="row">
        <div class="col"><label>Responsable<select id="iResp"></select></label></div>
        <div class="col"><label>Desde<input type="date" id="iDesde"></label></div>
        <div class="col"><label>Hasta<input type="date" id="iHasta"></label></div>
        <div class="col" style="align-self:end;text-align:right">
          <button class="btn ghost small" id="btnPrintIndic">Imprimir</button>
          <button class="btn ghost small" id="btnXlsIndic">Exportar XLS</button>
        </div>
      </div>
    </div>
    <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div><h3>Tareas</h3><svg id="chartTareas" width="100%" height="240"></svg></div>
      <div><h3>Agenda</h3><svg id="chartAgenda" width="100%" height="240"></svg></div>
    </div>
    <div class="section" id="indicResumen"></div>
  </section>
<!-- REPORTE QR -->
<section id="viewReporte" class="section" style="display:none">
  <h2>Reporte de tareas</h2>
  <div id="reporteMeta" class="muted" style="margin-bottom:12px"></div>
  <div class="card">
    <div class="row no-print" style="gap:8px; align-items:center">
      <button class="btn ghost" onclick="window.print()">Imprimir</button>
      <button class="btn" id="btnExportReporteXLS">Exportar XLS</button>
    </div>
    <div class="table-wrap">
      <table class="table" id="tblReporte">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>


  <!-- IO -->
  <section id="view-io" class="view">
    <h2>Importar / Exportar</h2>
    <div class="section">
      <p class="muted">Exporta desde cada m√≥dulo a <strong>XLS</strong>. Para PDF usa los botones de imprimir.</p>
      <div style="text-align:right">
        <button class="btn danger" id="btnReset">Reiniciar sistema</button>
      </div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="view-ajustes" class="view">
    <h2>Ajustes del sistema</h2>
    <div class="section">
      <div class="row">
        <div class="col"><h3>Identidad visual</h3><label>Logotipo<input type="file" id="fileLogo" accept="image/*"></label><label>Fondo<input type="file" id="fileFondo" accept="image/*"></label></div>
        <div class="col"><h3>Preferencias</h3><label><input type="checkbox" id="chkInicioMenu" checked> Mostrar men√∫ al iniciar</label><p>Interfaz en espa√±ol.</p></div>
      </div>
      <div class="footer-actions"><button class="btn ok" id="btnGuardarAjustes">Guardar ajustes</button></div>
    </div>
  </section>

  <!-- AYUDA -->
  <section id="view-ayuda" class="view">
    <h2>Ayuda</h2>
    <div class="section">
      <p>1) Cargue el plano, elija herramienta (Rect√°ngulo/Pol√≠gono/Elipse), <strong>Iniciar</strong>, dibuje y <strong>Finalizar</strong>. Se pedir√° el nombre del sector.</p>
      <p>2) Seleccione una zona para moverla, renombrar, cambiar color o eliminar.</p>
      <p>3) En Tareas, cree tareas y use <em>Imprimir semana</em> con filtro de responsable y rango de semana editable. Los checks incluyen s√°bado si aplica.</p>
    </div>
  </section>
</main>

<footer>Suite Operativa ¬∑ v3.6.1</footer>

<script>
/* ===== Estado & helpers ===== */
const KEY="suite_operativa_v36";
let state={logo:null,fondo:null,plano:null,zonas:[],tareas:[],agenda:[],personal:[{n:"Wilson",c:"",t:""}]};
function load(){try{const raw=localStorage.getItem(KEY); if(raw) state=Object.assign(state,JSON.parse(raw));}catch(e){}}
function save(){localStorage.setItem(KEY,JSON.stringify(state)); refresh();}
function uid(){return Math.random().toString(36).slice(2,9);} const $=id=>document.getElementById(id);
function nav(route){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); ($('view-'+route)||$('view-home')).classList.add('active'); window.scrollTo(0,0)}
document.querySelectorAll('.tile').forEach(t=>t.addEventListener('click',()=>nav(t.dataset.route)));
$('btnAjustes').onclick=()=>nav('ajustes'); $('btnMenu').onclick=()=>nav('home');

/* ===== Marca ===== */
function applyBrand(){const ph='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect rx="10" width="180" height="60" fill="white"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Inter,Arial" font-size="20" fill="#0f8f89">LOGO</text></svg>`); $('brandLogo').src=state.logo||ph; if(state.fondo){document.body.style.backgroundImage=`url(${state.fondo})`; document.body.style.backgroundRepeat='no-repeat'; document.body.style.backgroundSize='contain';} else {document.body.style.backgroundImage='none';}}
$('btnGuardarAjustes').onclick=()=>{save(); alert('Ajustes guardados');};
$('fileLogo').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{state.logo=ev.target.result; save();}; r.readAsDataURL(f);};
$('fileFondo').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{state.fondo=ev.target.result; save();}; r.readAsDataURL(f);};

/* ===== KPIs e Indicadores ===== */
function kpis(){const today=new Date().toISOString().slice(0,10); const tPend=state.tareas.filter(t=>t.estado!=='completada').length; const tComp=state.tareas.filter(t=>t.estado==='completada').length; const tVenc=state.tareas.filter(t=>t.estado!=='completada' && t.fecha && t.fecha<today).length; const total=state.tareas.length||1; $('kpiActivas').textContent=tPend; $('kpiCompletadas').textContent=tComp; $('kpiVencidas').textContent=tVenc; $('kpiCumplimiento').textContent=Math.round((tComp/total)*100)+'%';}
function node(tag,attrs,txt){const n=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs)n.setAttribute(k,attrs[k]); if(txt)n.textContent=txt; return n;}
function bars(id,data){const svg=$(id); const w=svg.clientWidth||600,h=+svg.getAttribute('height'); const ks=Object.keys(data); const max=Math.max(1,...Object.values(data)); const bw=Math.max(24,(w-40)/ks.length-10); svg.innerHTML=''; ks.forEach((k,i)=>{const x=20+i*(bw+10), val=data[k], bh=(h-50)*(val/max), y=h-30-bh; svg.appendChild(node('rect',{x,y,width:bw,height:bh,fill:'#0fa7a0'})); svg.appendChild(node('text',{x:x+bw/2,y:h-10,'text-anchor':'middle',style:'font-size:12px'},k)); svg.appendChild(node('text',{x:x+bw/2,y:y-4,'text-anchor':'middle',style:'font-size:12px'},val)); });}
function chartsFiltered(){
  const r=$('iResp').value, d=$('iDesde').value, h=$('iHasta').value;
  const inRange=(f)=>(!d||f>=d)&&(!h||f<=h);
  const tareasFil=state.tareas.filter(t=>(!r||t.resp===r)&&(!t.fecha || inRange(t.fecha)));
  const agendaFil=state.agenda.filter(a=>(!r||a.resp===r)&&(!a.fecha || inRange(a.fecha)));
  const today=new Date().toISOString().slice(0,10);
  const tData={pendientes:tareasFil.filter(t=>t.estado==='pendiente').length,"en progreso":tareasFil.filter(t=>t.estado==='en_progreso').length,vencidas:tareasFil.filter(t=>t.estado!=='completada'&&t.fecha&&t.fecha<today).length,completadas:tareasFil.filter(t=>t.estado==='completada').length};
  const aData={pendientes:agendaFil.filter(a=>a.estado!=='completado').length,completadas:agendaFil.filter(a=>a.estado==='completado').length};
  bars('chartTareas',tData); bars('chartAgenda',aData);
  $('indicResumen').innerHTML=`<h3>Resumen</h3>
    <table><thead><tr><th>Indicador</th><th>Pendientes</th><th>En progreso</th><th>Vencidas</th><th>Completadas</th></tr></thead>
    <tbody><tr><td>Tareas</td><td>${tData.pendientes}</td><td>${tData["en progreso"]}</td><td>${tData.vencidas}</td><td>${tData.completadas}</td></tr>
    <tr><td>Agenda</td><td>${aData.pendientes}</td><td>-</td><td>-</td><td>${aData.completadas}</td></tr></tbody></table>`;
}
function charts(){chartsFiltered();}
$('btnPrintIndic').onclick=()=>{window.print();};
$('btnXlsIndic').onclick=()=>{
  const html=$('indicResumen').innerHTML;
  downloadXLS('indicadores.xls', `<table>${html}</table>`);
};

/* ===== Personal ===== */
function renderPersonal(){const tb=$('tblPersonal').querySelector('tbody'); tb.innerHTML=''; state.personal.forEach((p,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.n}</td><td>${p.c||''}</td><td>${p.t||''}</td><td style="text-align:right"><button class="btn small danger" data-del="${i}">Eliminar</button></td>`; tb.appendChild(tr);}); tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{state.personal.splice(+b.dataset.del,1); save();}); const names=state.personal.map(x=>x.n); const combos=[ $('aResp'),$('tResp'),$('fResp'),$('iResp') ]; combos.forEach(c=>{c.innerHTML='<option value="">(Todos)</option>'+names.map(n=>`<option>${n}</option>`).join('');}); }
$('btnAddPers').onclick=()=>{const n=$('pNombre').value.trim(), c=$('pCargo').value.trim(), t=$('pTel').value.trim(); if(!n) return; if(!state.personal.some(x=>x.n===n)) state.personal.push({n,c,t}); $('pNombre').value=$('pCargo').value=$('pTel').value=''; save();};

/* ===== Agenda ===== */
$('btnAddAgenda').onclick=()=>{const resp=$('aResp').value, fecha=$('aFecha').value, desc=$('aDesc').value.trim(), est=$('aEstado').value; if(!resp||!fecha||!desc) return alert('Completa responsable, fecha y descripci√≥n'); state.agenda.push({id:uid(),resp,fecha,desc,estado:est}); $('aDesc').value=''; save();};
function renderAgenda(){const tb=$('tblAgenda').querySelector('tbody'); tb.innerHTML=''; [...state.agenda].sort((a,b)=>a.fecha.localeCompare(b.fecha)).forEach(a=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.fecha}</td><td>${a.resp}</td><td>${a.desc}</td><td><span class="badge">${a.estado}</span></td><td class="no-print" style="text-align:right"><button class="btn small" data-tg="${a.id}">Cambiar estado</button> <button class="btn small danger" data-del="${a.id}">Eliminar</button></td>`; tb.appendChild(tr);}); tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{state.agenda=state.agenda.filter(x=>x.id!==b.dataset.del); save();}); tb.querySelectorAll('[data-tg]').forEach(b=>b.onclick=()=>{const ag=state.agenda.find(x=>x.id===b.dataset.tg); ag.estado=ag.estado==='pendiente'?'completado':'pendiente'; save();});}
$('btnXlsAgenda').onclick=()=>{downloadXLS('agenda.xls', tableHTML($('tblAgenda')));};

/* ===== Planos, zoom y dibujo (igual que v3.6) ===== */
const stage=$('stage'), img=$('planoImg'), svg=$('svgLayer'); let scale=1, offX=0, offY=0;
function applyTr(){stage.style.transform=`translate(${offX}px,${offY}px) scale(${scale})`; svg.setAttribute('width', img.naturalWidth||800); svg.setAttribute('height', img.naturalHeight||600);}
function fit(){const cw=$('canvasWrap').clientWidth, ch=$('canvasWrap').clientHeight; if(!img.naturalWidth){scale=1;offX=offY=0;applyTr();return;} const sx=cw/(img.naturalWidth+20), sy=ch/(img.naturalHeight+20); scale=Math.min(sx,sy); offX=10; offY=10; applyTr();}
$('btnZoomIn').onclick=()=>{scale*=1.1; applyTr();}; $('btnZoomOut').onclick=()=>{scale/=1.1; applyTr();}; $('btnZoomFit').onclick=fit;
let panning=false, panStart=[0,0];
$('canvasWrap').addEventListener('mousedown',e=>{if(e.target===svg||e.target===img){if(drawing) return; panning=true; panStart=[e.clientX-offX,e.clientY-offY];}});
window.addEventListener('mousemove',e=>{if(panning){offX=e.clientX-panStart[0]; offY=e.clientY-panStart[1]; applyTr();}});
window.addEventListener('mouseup',()=>panning=false);
$('canvasWrap').addEventListener('wheel',e=>{e.preventDefault(); const d=e.deltaY<0?1.1:0.9; const mx=(e.offsetX-offX)/scale,my=(e.offsetY-offY)/scale; scale*=d; offX=e.offsetX-mx*scale; offY=e.offsetY-my*scale; applyTr();},{passive:false});
$('filePlano').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{state.plano=ev.target.result; img.src=state.plano; setTimeout(fit,20); save();}; r.readAsDataURL(f);};
$('btnPlanoReset').onclick=()=>{state.plano=null; img.removeAttribute('src'); svg.innerHTML=''; state.zonas=[]; save();};
$('btnPrintPlano').onclick=()=>{window.print();};
$('btnXlsPlano').onclick=()=>{
  const table=`<table border="1"><tr><th>Zona</th><th>Color</th><th>Puntos</th></tr>${
    state.zonas.map(z=>`<tr><td>${z.nombre}</td><td>${z.color}</td><td>${z.pts.length}</td></tr>`).join('')
  }</table>`;
  downloadXLS('zonas.xls', table);
};

let drawing=false, tool='poly', start=null, points=[], selected=null, draggingZone=null, dragStart=[0,0], drawingDrag=false;
$('toolKind').onchange=e=>tool=e.target.value;
$('btnIniciar').onclick=()=>{drawing=true; start=null; points=[]; drawingDrag=false; svg.querySelectorAll('.temp').forEach(n=>n.remove());};
$('btnFinalizar').onclick=finishDraw;

function toLocal(e){const r=svg.getBoundingClientRect(); return [(e.clientX-r.left)/scale,(e.clientY-r.top)/scale];}
function ptsStr(a){return a.map(p=>p.join(',')).join(' ');}
function centroid(pts){let x=0,y=0; pts.forEach(p=>{x+=p[0]; y+=p[1];}); return [x/pts.length, y/pts.length];}
function polygonArea(pts){let a=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++){a+= (pts[j][0]*pts[i][1]-pts[i][0]*pts[j][1]);} return Math.abs(a/2);}

svg.addEventListener('mousedown',e=>{
  if(!drawing){
    const t=e.target.closest('[data-zid]');
    if(!t){selectZone(null); return;}
    selectZone(t.getAttribute('data-zid'));
    draggingZone=t.getAttribute('data-zid');
    dragStart=toLocal(e);
    return;
  }
  const pt=toLocal(e);
  if(tool==='rect' || tool==='ellipse'){ start=pt; drawingDrag=true; drawTemp(pt); }
});
svg.addEventListener('mousemove',e=>{
  if(drawing){
    const pt=toLocal(e);
    if(tool==='poly'){ drawTemp(pt); }
    if(drawingDrag && (tool==='rect' || tool==='ellipse')){ drawTemp(pt); }
  }
  if(draggingZone){
    const cur=toLocal(e);
    const dx=cur[0]-dragStart[0], dy=cur[1]-dragStart[1];
    dragStart=cur;
    const z=state.zonas.find(x=>x.id===draggingZone); if(!z) return;
    z.pts=z.pts.map(([x,y])=>[x+dx,y+dy]);
    renderZonas(false);
  }
});
window.addEventListener('mouseup',e=>{
  if(drawing && drawingDrag && (tool==='rect'||tool==='ellipse')){ const pt=toLocal(e); drawingDrag=false; finishDraw(pt); }
  if(draggingZone){ draggingZone=null; save(); }
});
svg.addEventListener('click',e=>{
  if(!drawing) return;
  if(tool==='poly'){ points.push(toLocal(e)); drawTemp(); }
});
svg.addEventListener('dblclick',()=>{ if(drawing && tool==='poly') finishDraw(); });

function drawTemp(cursorPt){
  svg.querySelectorAll('.temp').forEach(n=>n.remove());
  const color=$('zonaColor').value;
  if(tool==='poly'){
    const preview=cursorPt ? points.concat([cursorPt]) : points.slice();
    if(preview.length){ const pl=document.createElementNS('http://www.w3.org/2000/svg','polyline'); pl.setAttribute('points',ptsStr(preview)); pl.setAttribute('fill','rgba(15,167,160,0.12)'); pl.setAttribute('stroke',color); pl.setAttribute('stroke-width','2'); pl.setAttribute('class','temp'); svg.appendChild(pl); }
  }
  if(tool==='rect' && start && cursorPt){
    const x=Math.min(start[0],cursorPt[0]), y=Math.min(start[1],cursorPt[1]), w=Math.abs(start[0]-cursorPt[0]), h=Math.abs(start[1]-cursorPt[1]);
    const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',w); r.setAttribute('height',h); r.setAttribute('fill','rgba(15,167,160,0.12)'); r.setAttribute('stroke',color); r.setAttribute('stroke-width','2'); r.setAttribute('class','temp'); svg.appendChild(r);
  }
  if(tool==='ellipse' && start && cursorPt){
    const cx=(start[0]+cursorPt[0])/2, cy=(start[1]+cursorPt[1])/2, rx=Math.abs(start[0]-cursorPt[0])/2, ry=Math.abs(start[1]-cursorPt[1])/2;
    const el=document.createElementNS('http://www.w3.org/2000/svg','ellipse'); el.setAttribute('cx',cx); el.setAttribute('cy',cy); el.setAttribute('rx',rx); el.setAttribute('ry',ry); el.setAttribute('fill','rgba(15,167,160,0.12)'); el.setAttribute('stroke',color); el.setAttribute('stroke-width','2'); el.setAttribute('class','temp'); svg.appendChild(el);
  }
}

function finishDraw(p2){
  if(!drawing) return; drawing=false;
  const nombrePrompt=$('zonaNombre').value.trim()||prompt('Nombre de la zona','Zona '+(state.zonas.length+1))||('Zona '+(state.zonas.length+1));
  const color=$('zonaColor').value||'#0fa7a0';
  let pts=[];
  if(tool==='poly'){ if(points.length<3){alert('Dibuja al menos 3 puntos'); return;} pts=points.slice(); }
  else if(tool==='rect'){ if(!start||!p2) return; const x1=start[0],y1=start[1],x2=p2[0],y2=p2[1]; pts=[[x1,y1],[x2,y1],[x2,y2],[x1,y2]]; }
  else if(tool==='ellipse'){ if(!start||!p2) return; const cx=(start[0]+p2[0])/2, cy=(start[1]+p2[1])/2, rx=Math.abs(start[0]-p2[0])/2, ry=Math.abs(start[1]-p2[1])/2; const N=40; for(let i=0;i<N;i++){const a=i*2*Math.PI/N; pts.push([cx+rx*Math.cos(a), cy+ry*Math.sin(a)]);} }
  svg.querySelectorAll('.temp').forEach(n=>n.remove());
  start=null; points=[]; drawingDrag=false;
  state.zonas.push({id:uid(),nombre:nombrePrompt,color,pts});
  renderZonas(false); save();
}

function renderZonas(){
  const lg=$('legend'); lg.innerHTML=''; state.zonas.forEach(z=>{const s=document.createElement('span'); s.className='badge'; s.style.borderColor=z.color; s.style.color=z.color; s.textContent=z.nombre; lg.appendChild(s);});
  const list=$('zonasList'); if(!state.zonas.length){list.textContent='A√∫n no hay zonas.'; list.className='muted';} else {
    list.className=''; list.innerHTML=`<table><thead><tr><th>Zona</th><th>Color</th><th>Puntos</th><th>√Årea</th><th></th></tr></thead><tbody>
      ${state.zonas.map(z=>`<tr data-id="${z.id}"><td>${z.nombre}</td><td><span class="badge" style="border-color:${z.color};color:${z.color}">${z.color}</span></td><td>${z.pts.length}</td><td>${Math.round(polygonArea(z.pts))} px¬≤</td><td style="text-align:right"><button class="btn small" data-sel="${z.id}">Seleccionar</button> <button class="btn small danger" data-del="${z.id}">Eliminar</button></td></tr>`).join('')}
    </tbody></table>`;
    list.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{state.zonas=state.zonas.filter(x=>x.id!==b.dataset.del); if(selected===b.dataset.del) selected=null; save();});
    list.querySelectorAll('[data-sel]').forEach(b=>b.onclick=()=>selectZone(b.dataset.sel));
  }
  svg.innerHTML='';
  state.zonas.forEach(z=>{
    const pg=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pg.setAttribute('points',ptsStr(z.pts)); pg.setAttribute('fill',z.color+'33'); pg.setAttribute('stroke',z.color); pg.setAttribute('stroke-width','2'); pg.setAttribute('data-zid',z.id); if(z.id===selected) pg.classList.add('zone-selected'); svg.appendChild(pg);
    const c=centroid(z.pts); const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x',c[0]); label.setAttribute('y',c[1]); label.setAttribute('text-anchor','middle'); label.setAttribute('style','font:bold 16px Inter,Arial;fill:#0b3a37;paint-order:stroke;stroke:#fff;stroke-width:3'); label.textContent=z.nombre; svg.appendChild(label);
  });
  svg.querySelectorAll('[data-zid]').forEach(elm=>{ elm.addEventListener('mousedown',e=>{const id=elm.getAttribute('data-zid'); selectZone(id); draggingZone=id; dragStart=toLocal(e); e.stopPropagation();}); });
}
function selectZone(id){selected=id; renderZonas();}

/* ===== Tareas ===== */
function dayInitial(d){return ['D','L','M','M','J','V','S'][d];}
function getWeekCols(start,end){
  const s=new Date(start), e=new Date(end);
  const days=[]; const cur=new Date(s);
  while(cur<=e){days.push(dayInitial(cur.getDay())); cur.setDate(cur.getDate()+1);}
  const order=['L','M','M','J','V','S']; const result=[]; order.forEach(ch=>{ if(days.includes(ch)) result.push(ch); });
  return result.length?result:order; // fallback si rango vac√≠o
}
function renderTareas(){
  const sel=$('tZona'); sel.innerHTML='<option value="">(Sin zona)</option>'; state.zonas.forEach(z=>{const o=document.createElement('option'); o.value=z.id; o.textContent=z.nombre; sel.appendChild(o);});
  const names=state.personal.map(x=>x.n); $('tResp').innerHTML='<option value="">(Seleccione)</option>'+names.map(n=>`<option>${n}</option>`).join(''); if(!$('fResp').value) $('fResp').innerHTML='<option value="">(Todos)</option>'+names.map(n=>`<option>${n}</option>`).join('');
  const fResp=$('fResp').value; const rows=[...state.tareas].filter(t=>!fResp||t.resp===fResp).sort((a,b)=>a.fecha.localeCompare(b.fecha));
  let wcols=['L','M','M','J','V','S']; if($('wStart').value && $('wEnd').value) wcols=getWeekCols($('wStart').value,$('wEnd').value);
  const thead=$('theadTareas'); thead.innerHTML=`<tr><th>Fecha</th><th>T√≠tulo</th><th>Zona</th><th>Responsable</th><th>Estado</th><th>Frecuencia</th><th>Inicio</th><th>Fin</th><th>Descripci√≥n</th>${wcols.map(c=>`<th>${c}</th>`).join('')}<th class="no-print"></th></tr>`;
  const tb=$('tblTareas').querySelector('tbody'); tb.innerHTML='';
  rows.forEach(t=>{const z=state.zonas.find(x=>x.id===t.zonaId); const tr=document.createElement('tr'); const checks=wcols.map(()=>'<td><input type="checkbox"></td>').join(''); tr.innerHTML=`<td>${t.fecha||''}</td><td>${t.titulo||''}</td><td>${z?z.nombre:''}</td><td>${t.resp||''}</td>
  <td><select data-st="${t.id}"><option value="pendiente"${t.estado==='pendiente'?' selected':''}>pendiente</option><option value="en_progreso"${t.estado==='en_progreso'?' selected':''}>en_progreso</option><option value="completada"${t.estado==='completada'?' selected':''}>completada</option></select></td>
  <td>${t.frecuencia||''}</td>
  <td>${t.inicio||''}</td><td>${t.fin||''}</td><td>${(t.desc||'').replace(/\n/g,' ')}</td>${checks}<td class="no-print" style="text-align:right"><button class="btn small danger" data-del="${t.id}">Eliminar</button></td>`; tb.appendChild(tr);});
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{state.tareas=state.tareas.filter(x=>x.id!==b.dataset.del); save();}); tb.querySelectorAll('[data-st]').forEach(s=>s.onchange=()=>{const t=state.tareas.find(x=>x.id===s.dataset.st); t.estado=s.value; save();});
}
$('btnCrearTarea').onclick=()=>{
  const titulo=$('tTitulo').value.trim(); const fecha=$('tInicio').value; if(!titulo||!fecha) return alert('T√≠tulo y fecha requeridos');
  const fin=$('tFin').value||fecha; state.tareas.push({id:uid(),titulo,fecha,inicio:fecha,fin:fin,frecuencia:$('tFreq').value,zonaId:$('tZona').value||null,resp:$('tResp').value||'',estado:$('tEstado').value,desc:$('tDesc').value.trim()});
  $('tTitulo').value=''; $('tDesc').value=''; save();
};
$('btnXlsTareas').onclick=()=>{downloadXLS('tareas.xls', tableHTML($('tblTareas')));};
$('wStart').onchange=renderTareas; $('wEnd').onchange=renderTareas; $('fResp').onchange=renderTareas; // <-- fix filtro responsable
$('btnPrintSemana').onclick=()=>{
  const s=$('wStart').value, e=$('wEnd').value; const resp=$('fResp').value||'Todos';
  $('printMeta').textContent=`Responsable: ${resp} ¬∑ Semana: ${s||'--'} a ${e||'--'}`; $('printLogo').src=state.logo||$('brandLogo').src; window.print();
};
$('btnPrintPlano').onclick=()=>{ $('printLogoPlanos').src=state.logo||$('brandLogo').src; fit(); window.print(); };

/* ===== Export helpers (XLS via HTML table) ===== */
function tableHTML(table){const clone=table.cloneNode(true); clone.querySelectorAll('.no-print').forEach(el=>el.remove()); return clone.outerHTML;}
function downloadXLS(filename, html){const blob=new Blob([`<html><head><meta charset="utf-8"></head><body>${html}</body></html>`],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},1000);}

/* ===== Reinicio ===== */
$('btnReset').onclick=()=>{ if(confirm('Esto borrar√° todos los datos locales. ¬øContinuar?')){ localStorage.removeItem(KEY); location.reload(); } };

/* ===== Inicializaci√≥n / render ===== */
function refresh(){
  applyBrand(); kpis(); charts();
  if(state.plano){$('planoImg').src=state.plano; setTimeout(fit,20);} else {$('planoImg').removeAttribute('src'); fit();}
  renderPersonal();
  renderAgenda();
  renderZonas();
  renderTareas();
  chartsFiltered();
}

// ensure indicadores filtros react
$('iResp').onchange=chartsFiltered; $('iDesde').onchange=chartsFiltered; $('iHasta').onchange=chartsFiltered;


// ==== QR & Reporte ====
function encodeB64(str){try{return btoa(unescape(encodeURIComponent(str)));}catch(e){return btoa(str);}}
function decodeB64(str){try{return decodeURIComponent(escape(atob(str)));}catch(e){return atob(str);}}
function buildReporteRowsFrom(data){
  const tbody=$('tblReporte').querySelector('tbody');
  const thead=$('tblReporte').querySelector('thead');
  thead.innerHTML=`<tr>
    <th>Fecha</th><th>T√≠tulo</th><th>Zona</th><th>Responsable</th>
    <th>Estado</th><th>Frecuencia</th><th>Inicio</th><th>Fin</th><th>Descripci√≥n</th>
  </tr>`;
  tbody.innerHTML='';
  (data.tareas||[]).forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.fecha||''}</td><td>${t.titulo||''}</td><td>${t.zona||''}</td>
      <td>${t.responsable||''}</td><td>${t.estado||''}</td><td>${t.frecuencia||''}</td>
      <td>${t.inicio||''}</td><td>${t.fin||''}</td><td>${t.descripcion||''}</td>`;
    tbody.appendChild(tr);
  });
}
function gotoReporteFromHash(){
  const hs=location.hash.slice(1);
  const m=hs.match(/(?:^|&)d=([^&]+)/);
  if(!m) return false;
  let payload={};
  try{ payload=JSON.parse(decodeB64(m[1])); }catch(_){}
  $('home').style.display='none';
  $('viewPlanos').style.display='none';
  $('viewTareas').style.display='none';
  $('viewAgenda').style.display='none';
  $('viewIndicadores').style.display='none';
  $('viewPersonal').style.display='none';
  $('viewImport').style.display='none';
  $('viewAjustes').style.display='none';
  $('viewReporte').style.display='block';
  $('reporteMeta').textContent=`Generado: ${payload.meta?.generado||''} ‚Ä¢ Total tareas: ${(payload.tareas||[]).length}`;
  buildReporteRowsFrom(payload);
  // export XLS
  $('btnExportReporteXLS').onclick=()=>{
    const rows = [['Fecha','T√≠tulo','Zona','Responsable','Estado','Frecuencia','Inicio','Fin','Descripci√≥n']]
      .concat((payload.tareas||[]).map(t=>[t.fecha||'',t.titulo||'',t.zona||'',t.responsable||'',t.estado||'',t.frecuencia||'',t.inicio||'',t.fin||'',t.descripcion||'']));
    downloadXLS('reporte_qr.xlsx', rows);
  };
  return true;
}
window.addEventListener('hashchange', ()=>{ gotoReporteFromHash(); });

// Build dataset for QR (semana actual por defecto)
function buildQRData({modo='semana', zona=null}={}){
  const today=new Date();
  const start = new Date(today); start.setDate(start.getDate()- (start.getDay()||7) +1); // Lunes
  const end = new Date(start); end.setDate(start.getDate()+6);
  let tareas = [...state.tareas];
  if(modo==='semana'){
    const s=start.toISOString().slice(0,10), e=end.toISOString().slice(0,10);
    tareas=tareas.filter(t=> (t.inicio||t.fecha||'')>=s && (t.fin||t.inicio||t.fecha||'')<=e );
  }
  if(zona){ tareas=tareas.filter(t=> (t.zona||'').toLowerCase()===(zona||'').toLowerCase()); }
  // Compact map
  const comp=tareas.map(t=>({fecha:t.fecha,titulo:t.titulo,zona:t.zona,responsable:t.responsable,estado:t.estado,frecuencia:t.frecuencia,inicio:t.inicio,fin:t.fin,descripcion:t.descripcion}));
  const payload={meta:{generado:new Date().toLocaleString()}, tareas:comp};
  return payload;
}

// Generate QR overlay and make it draggable
function makeOverlayDraggable(el){
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  el.addEventListener('mousedown', e=>{dragging=true; sx=e.clientX; sy=e.clientY; const r=el.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault();});
  window.addEventListener('mousemove', e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; el.style.left=(ox+dx)+'px'; el.style.top=(oy+dy)+'px'; el.style.right='unset'; el.style.bottom='unset'; });
  window.addEventListener('mouseup', ()=>{ dragging=false; });
}
makeOverlayDraggable($('qrOverlay'));

$('btnInsertQR').onclick=()=>{
  const zonaSel = ($('zonaNombre')?.value||'').trim() || null;
  const data = buildQRData({modo:'semana', zona:null});
  try{
    const b64 = encodeB64(JSON.stringify(data));
    const base = location.href.split('#')[0].split('?')[0];
    const link = base + '?view=reporte#d=' + encodeURIComponent(b64);
    const src = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + encodeURIComponent(link);
    $('qrImg').src = src;
    $('qrOverlay').style.display='block';
    $('qrOverlay').onclick = ()=>{ window.open(link, '_blank'); };
  }catch(err){
    alert('No se pudo generar el QR (datos demasiado grandes). Filtra por semana o zona e int√©ntalo de nuevo.');
  }
};

// Si entramos con ?view=reporte usamos el hash d=... para dibujar la tabla
(function(){
  const qs = new URLSearchParams(location.search);
  if(qs.get('view')==='reporte'){
    gotoReporteFromHash();
  }
})();

load(); refresh();
</script>
</body>
</html>
