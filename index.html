<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Negocios RD â€“ Buscador por Provincia/Municipio</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{
      --bg:#f6f8fc; --card:#ffffff; --muted:#64748b; --text:#0b1220;
      --primary:#14b8a6; --danger:#ef4444; --chip:#eef2f7; --border:#e5e9f2;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#f6f8fc 0%, #eef2f7 100%); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:16px;}
    .title{display:flex; align-items:center; gap:10px; margin:0 0 10px; }
    .badge{background:var(--chip); color:#475569; border:1px solid #e2e8f0; padding:3px 8px; border-radius:999px; font-size:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 6px 16px rgba(15,23,42,.06);}
    .muted{color:var(--muted); font-size:12px;}
    .grid{display:grid; gap:8px;}
    .grid-3{grid-template-columns: repeat(3, minmax(0, 1fr));}
    .grid-4{grid-template-columns: repeat(4, minmax(0, 1fr));}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    select,input[type="text"],button{width:100%; padding:10px; border-radius:12px; border:1px solid #d7dde8; background:#fff; color:var(--text); outline:none;}
    button{cursor:pointer; font-weight:600;}
    .btn{border:1px solid #dbe1ea; background:#ffffff;}
    .btn-primary{background: linear-gradient(135deg, #10b981, #14b8a6); border:0; color:#ffffff;}
    .btn-danger{background: linear-gradient(135deg, #dc2626, #ef4444); border:0; color:#ffffff;}
    .chip{padding:2px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:#475569; border:1px solid #e2e8f0;}
    #map{width:100%; height:64vh; border-radius:14px; border:1px solid #dbe1ea; background:#eef2f7;}
    .table-wrap{max-height:60vh; overflow:auto; border-radius:12px; border:1px solid var(--border);}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th, td{padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:top;}
    th{position:sticky; top:0; background:#f4f7fb; color:#64748b; z-index:1;}
    .errbar{position:fixed; left:8px; right:8px; bottom:8px; background:#fde8e8; border:1px solid #f8b4b4; color:#7f1d1d; padding:8px 10px; border-radius:12px; display:none;}
    .okbar{position:fixed; left:8px; right:8px; bottom:8px; background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; padding:8px 10px; border-radius:12px; display:none;}
    .spinner{display:inline-block; width:16px; height:16px; border:2px solid #dbe1ea; border-top:2px solid #14b8a6; border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:middle;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid #e5e9f2;}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg,#10b981,#14b8a6); transition:width .25s;}
    .hint{font-size:12px; color:#64748b;}
    .link{color:#0ea5e9; text-decoration:none}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h2 style="margin:0">Negocios RD</h2>
      <span class="badge">OSM + Overpass</span>
      <span class="badge">Single-file</span>
      <span class="badge">Listo para GitHub Pages</span>
    </div>

    <div class="card">
      <div class="grid grid-4">
        <div>
          <label class="muted">Tipo de negocio (buscador)</label>
          <input id="qTipo" type="text" placeholder="Ej.: ferreterÃ­a, papelerÃ­a, farmacia..." />
        </div>
        <div>
          <label class="muted">Provincia</label>
          <select id="selProv"></select>
        </div>
        <div>
          <label class="muted">Municipio (opcional)</label>
          <select id="selMuni"><option value="">(todos)</option></select>
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button id="btnBuscar" class="btn btn-primary" style="flex:1">ðŸ”Ž Buscar</button>
          <button id="btnCSV" class="btn" style="flex:1">â¬‡ CSV</button>
        </div>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <div class="progress" style="flex:1; min-width:120px;"><div id="pbar"></div></div>
        <span id="status" class="hint">Listo</span>
        <button id="btnCargarMunicipios" class="btn">â†» Cargar municipios</button>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:10px;">
      <div class="card">
        <div id="map"></div>
        <div id="hintZero" class="hint" style="margin-top:6px; display:none;">Sin resultados para el Ã¡rea seleccionada.</div>
      </div>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between; margin-bottom:6px;">
          <div class="chip">Resultados: <span id="statCount">0</span></div>
          <div class="chip">Fuente: OpenStreetMap (cobertura variable)</div>
        </div>
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Nombre</th><th>Tipo</th><th>DirecciÃ³n</th><th>TelÃ©fono</th><th>Web</th><th>Lat</th><th>Lon</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="err" class="errbar"></div>
  <div id="ok" class="okbar"></div>

<script>
// ======= Provincias RD (31 + Distrito Nacional) =======
const PROVINCIAS = [
  "Azua","Bahoruco","Barahona","DajabÃ³n","Distrito Nacional","Duarte","ElÃ­as PiÃ±a","El Seibo","Espaillat",
  "Hato Mayor","Hermanas Mirabal","Independencia","La Altagracia","La Romana","La Vega","MarÃ­a Trinidad SÃ¡nchez",
  "MonseÃ±or Nouel","Monte Cristi","Monte Plata","Pedernales","Peravia","Puerto Plata","SamanÃ¡","San CristÃ³bal",
  "San JosÃ© de Ocoa","San Juan","San Pedro de MacorÃ­s","SÃ¡nchez RamÃ­rez","Santiago","Santiago RodrÃ­guez",
  "Santo Domingo","Valverde"
];

// ======= Estado =======
const STATE = {
  map: null, markers: [], features: [], municipios: [], lastArea: null,
};

// ======= Utils =======
function showErr(msg){const el=document.getElementById('err'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 3200);}
function showOk(msg){const el=document.getElementById('ok'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2000);}
function setStatus(text, p=null){ document.getElementById('status').textContent=text; if(p!=null){ document.getElementById('pbar').style.width = Math.max(0, Math.min(100, p)) + '%'; } }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n'))?('\"'+s.replace(/\"/g,'\"\"')+'\"'):s; }
function toCSV(rows, headers){
  const head = headers.map(h=>csvEscape(h)).join(',');
  const body = rows.map(r=> headers.map(h=>csvEscape(r[h])).join(',') ).join('\\n');
  return head + '\\n' + body;
}
function uniq(arr){return Array.from(new Set(arr))}
function norm(s){return (s??'').toString().trim().toLowerCase();}
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 75% 52%)`; }
function svgPin(color){ const fill=color||'#3b82f6'; const stroke='#0b1220'; const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38"><path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/><circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }

// ======= Map =======
function initMap(){
  if(STATE.map) return;
  const RD=[18.735693,-70.162651];
  STATE.map=L.map('map',{zoomControl:true}).setView(RD,8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map);
  window.addEventListener('resize', ()=>STATE.map&&STATE.map.invalidateSize());
}
function clearMarkers(){ STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function addMarker(lat, lon, props){
  const color=hashColor(props.tipo||'negocio');
  const marker=L.marker([lat,lon],{icon: L.icon({iconUrl: svgPin(color), iconSize:[26,38], iconAnchor:[13,36], popupAnchor:[0,-30]})});
  let addr = [props.address, props.city, props.state].filter(Boolean).join(', ');
  const phone = props.phone ? `<div>Tel: ${props.phone}</div>` : '';
  const web = props.website ? `<div>Web: <a class="link" href="${props.website}" target="_blank" rel="noopener">${props.website}</a></div>` : '';
  marker.bindPopup(`<strong>${props.name||'(sin nombre)'}</strong><div class="muted">${props.tipo||''}</div><div>${addr||''}</div>${phone}${web}`);
  marker.on('click', ()=>{
    // highlight row
    const idx = STATE.features.findIndex(f => f.lat === lat && f.lon === lon && f.name === props.name);
    if(idx>=0){ const row = document.querySelector(`#tbl tbody tr[data-idx="${idx}"]`); if(row){ row.scrollIntoView({behavior:'smooth', block:'center'}); row.classList.add('hl'); setTimeout(()=>row.classList.remove('hl'), 900); } }
  });
  marker.addTo(STATE.map);
  STATE.markers.push(marker);
}

// ======= Overpass helpers =======
const OVERPASS_SERVERS = [
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.ru/api/interpreter"
];

// Spanish keyword â†’ OSM tag candidates
const TAG_MAP = {
  'ferreteria': [{k:'shop', v:'hardware'}, {k:'shop', v:'doityourself'}, {k:'shop', v:'trade'}, {k:'shop', v:'construction_supplies'}],
  'papeleria': [{k:'shop', v:'stationery'}, {k:'shop', v:'office_supplies'}],
  'farmacia': [{k:'amenity', v:'pharmacy'}, {k:'shop', v:'chemist'}],
  'supermercado': [{k:'shop', v:'supermarket'}],
  'banco': [{k:'amenity', v:'bank'}],
  'restaurante': [{k:'amenity', v:'restaurant'}],
  'colmadon': [{k:'shop', v:'convenience'}],
};

function buildAreaString(prov, muni){
  let area = '';
  if(muni){ area += muni + ', '; }
  area += prov + ', Dominican Republic';
  return area;
}

function buildQuery(q, prov, muni){
  const kw = norm(q);
  const tags = TAG_MAP[kw] || null;
  const areaStr = buildAreaString(prov, muni);
  let body = '';
  if(tags){
    // disjunction of known tags
    const parts = tags.map(t => `node(area.a)["${t.k}"="${t.v}"]; way(area.a)["${t.k}"="${t.v}"]; relation(area.a)["${t.k}"="${t.v}"];`).join('\\n');
    body = `
      {{geocodeArea:${areaStr}}}->.a;
      (${parts})
      out center tags;`;
  }else{
    // fuzzy search by name/shop/amenity contains keyword (case-insensitive)
    const r = q.replace(/["']/g,'').trim();
    body = `
      {{geocodeArea:${areaStr}}}->.a;
      (
        node(area.a)["name"~"${r}", i];
        way(area.a)["name"~"${r}", i];
        relation(area.a)["name"~"${r}", i];
        node(area.a)["shop"~"${r}", i];
        way(area.a)["shop"~"${r}", i];
        relation(area.a)["shop"~"${r}", i];
        node(area.a)["amenity"~"${r}", i];
        way(area.a)["amenity"~"${r}", i];
        relation(area.a)["amenity"~"${r}", i];
      );
      out center tags;`;
  }
  return `[out:json][timeout:30];${body}`;
}

async function overpassFetch(query){
  let lastErr = null;
  for(const url of OVERPASS_SERVERS){
    try{
      const res = await fetch(url, {method:'POST', body: query, headers:{'Content-Type':'text/plain;charset=UTF-8'}});
      if(res.ok){
        return await res.json();
      }else{
        lastErr = new Error('Overpass HTTP '+res.status);
      }
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('Overpass error');
}

// ======= Municipios (dinÃ¡mico) =======
async function cargarMunicipios(){
  const prov = document.getElementById('selProv').value;
  if(!prov){ showErr('Primero seleccione una provincia.'); return; }
  setStatus('Buscando municipiosâ€¦', 15);
  const areaStr = buildAreaString(prov, null);
  const q = `[out:json][timeout:30];
    {{geocodeArea:${areaStr}}}->.p;
    (
      // lÃ­mites administrativos con nombre (posibles municipios y distritos)
      rel(area.p)["boundary"="administrative"]["name"];
      // lugares poblados
      node(area.p)["place"~"city|town|village|hamlet"];
    );
    out tags center;`;
  try{
    const data = await overpassFetch(q);
    const names = uniq((data.elements||[]).map(e => e.tags && e.tags.name).filter(Boolean));
    names.sort((a,b)=> String(a).localeCompare(String(b),'es',{numeric:true}));
    const sel = document.getElementById('selMuni');
    sel.innerHTML = '<option value="">(todos)</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
    setStatus('Municipios cargados', 100); showOk('Municipios actualizados');
    setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 600);
  }catch(e){
    console.error(e); showErr('No se pudieron cargar municipios (Overpass). Intente de nuevo.');
    setStatus('Error al cargar municipios', 0);
  }
}

// ======= Buscar negocios =======
async function buscar(){
  initMap();
  const q = document.getElementById('qTipo').value.trim();
  const prov = document.getElementById('selProv').value;
  const muni = document.getElementById('selMuni').value || null;
  if(!q){ showErr('Escriba el tipo de negocio a buscar.'); return; }
  if(!prov){ showErr('Seleccione una provincia.'); return; }
  setStatus('Consultando Overpassâ€¦', 20);
  const query = buildQuery(q, prov, muni);
  clearMarkers();
  document.querySelector('#tbl tbody').innerHTML = '';
  STATE.features = [];
  try{
    const data = await overpassFetch(query);
    const elements = data.elements || [];
    elements.forEach((el, idx) => {
      const lat = el.lat || (el.center && el.center.lat);
      const lon = el.lon || (el.center && el.center.lon);
      if(lat==null || lon==null) return;
      const t = el.tags || {};
      const tipo = t.shop || t.amenity || t.office || '';
      const feature = {
        name: t.name || '',
        tipo: tipo,
        address: [t['addr:street'], t['addr:housenumber']].filter(Boolean).join(' ') || t['addr:full'] || '',
        city: t['addr:city'] || t['is_in:city'] || '',
        state: t['addr:state'] || '',
        phone: t['phone'] || t['contact:phone'] || '',
        website: t['website'] || t['contact:website'] || '',
        lat: +lat, lon: +lon
      };
      STATE.features.push(feature);
    });
    renderResults();
    setStatus('Completado', 100);
    setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 700);
  }catch(e){
    console.error(e);
    showErr('Error consultando Overpass. Puede intentar de nuevo o cambiar el tÃ©rmino.');
    setStatus('Error', 0);
  }
}

function renderResults(){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  let bounds = [];
  STATE.features.forEach((f, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${f.name||''}</td>
      <td>${f.tipo||''}</td>
      <td>${[f.address,f.city,f.state].filter(Boolean).join(', ')}</td>
      <td>${f.phone||''}</td>
      <td>${f.website?`<a class="link" href="${f.website}" target="_blank" rel="noopener">link</a>`:''}</td>
      <td>${f.lat.toFixed(6)}</td>
      <td>${f.lon.toFixed(6)}</td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=>{
      STATE.map.setView([f.lat, f.lon], 17);
    });
    tb.appendChild(tr);
    addMarker(f.lat, f.lon, f);
    bounds.push([f.lat, f.lon]);
  });
  document.getElementById('statCount').textContent = STATE.features.length;
  document.getElementById('hintZero').style.display = STATE.features.length ? 'none' : 'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); }
}

function exportCSV(){
  if(!STATE.features.length){ showErr('No hay resultados para exportar.'); return; }
  const headers = ['name','tipo','address','city','state','phone','website','lat','lon'];
  const csv = toCSV(STATE.features, headers);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'negocios_rd.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ======= Inicio =======
function init(){
  initMap();
  // provincias
  const selP = document.getElementById('selProv');
  selP.innerHTML = '<option value="">(seleccione)</option>' + PROVINCIAS.map(p=>`<option value="${p}">${p}</option>`).join('');
  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnCSV').addEventListener('click', exportCSV);
  document.getElementById('btnCargarMunicipios').addEventListener('click', cargarMunicipios);
  // Demo defaults
  document.getElementById('qTipo').value = 'ferreteria';
  selP.value = 'Puerto Plata';
  setStatus('Listo', 0);
}
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
