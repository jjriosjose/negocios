<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestion de Clientes y rutas ‚Äì jr1.1</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    :root{ --bg:#f7fafc; --card:#ffffff; --muted:#64748b; --text:#0b1220; --border:#e5e9f2; --chip:#eef2f7; --accent:#10b981; --warn:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#f6f8fc 0%, #eef2f7 100%); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:16px;}
    .title{display:flex; align-items:center; gap:10px; margin:0 0 10px;}
    .badge{background:var(--chip); color:#475569; border:1px solid #e2e8f0; padding:3px 8px; border-radius:999px; font-size:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 6px 16px rgba(15,23,42,.06);}
    .muted{color:var(--muted); font-size:12px;}
    .grid{display:grid; gap:12px;}
    .grid-4{grid-template-columns: repeat(4, minmax(0, 1fr));}
    select,input[type="text"],button{width:100%; padding:10px; border-radius:12px; border:1px solid #d7dde8; background:#fff; color:#0b1220; outline:none;}
    button{cursor:pointer; font-weight:600;}
    .btn{border:1px solid #dbe1ea; background:#ffffff;}
    .btn-primary{background: linear-gradient(135deg, var(--accent), #14b8a6); border:0; color:#ffffff;}
    #map{width:100%; height:64vh; border-radius:14px; border:1px solid #dbe1ea; background:#eef2f7;}
    .table-wrap{max-height:55vh; overflow:auto; border-radius:12px; border:1px solid var(--border);}
    table{width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;}
    th, td{padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:top; word-wrap:break-word; overflow-wrap:break-word; white-space:normal;}
    th{position:sticky; top:0; background:#f4f7fb; color:#64748b; z-index:1;}
    .errbar,.okbar{position:fixed; left:8px; right:8px; bottom:8px; padding:8px 10px; border-radius:12px; display:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index:9999;}
    .errbar{background:#fde8e8; border:1px solid #f8b4b4; color:#7f1d1d;}
    .okbar{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;}
    .progress{height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid #e5e9f2;}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg,#10b981,#14b8a6); transition:width .25s;}
    .chips{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #e2e8f0; background:#f8fafc; color:#334155;}
    .a{color:#0ea5e9; text-decoration:none;} .a:hover{text-decoration:underline;}
    details.results{border:1px solid var(--border); border-radius:16px; background:var(--card); box-shadow:0 6px 16px rgba(15,23,42,.06); padding:0;}
    details.results > summary{list-style:none; cursor:pointer; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid var(--border);}
    details.results > summary::-webkit-details-marker{display:none}
    .caret{transition:transform .2s ease;} details[open] .caret{transform:rotate(90deg);}
    .summary-right{display:flex; gap:8px; align-items:center;}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h2 style="margin:0">Gestion de Clientes y rutas</h2>
      <span class="badge">versi√≥n jr1.2</span>
    </div>

    <!-- Filtros -->
    <div class="card">
      <div class="grid grid-4">
        <div>
          <label class="muted">Tipo / palabra libre</label>
          <input id="qTipo" type="text" placeholder="Ej.: constructoras, concreteras, supermercados, tiendas de chinos‚Ä¶ o 'todos'"/>
        </div>
        <div>
          <label class="muted">Provincia (opcional)</label>
          <select id="selProv"><option value="">(todo el pa√≠s)</option></select>
        </div>
        <div>
          <label class="muted">Municipio (opcional)</label>
          <select id="selMuni"><option value="">(todos)</option></select>
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button id="btnBuscar" class="btn btn-primary" style="flex:1">üîé Buscar</button>
          <button id="btnCSV" class="btn" style="flex:1">‚¨á CSV</button>
          <button id="btnGMaps" class="btn" style="flex:1">üîé Google</button>
          <button id="btnFormNuevo" class="btn" style="flex:1">üìã Formulario</button>
        </div>
      </div>
      <div class="chips" style="margin-top:8px">
        <div class="progress" style="flex:1; min-width:160px;"><div id="pbar"></div></div>
        <span id="status" class="muted">Listo</span>
        <label><input type="checkbox" id="cbCluster" checked/> Clustering</label>
        <label><input type="checkbox" id="cbRapido" checked/> Modo r√°pido</label>
        <label class="muted">Filtro:</label>
        <label><input type="checkbox" id="cbTel"/> Con tel√©fono</label>
        <label><input type="checkbox" id="cbWeb"/> Con web</label>
        <button id="btnGPS" class="btn" title="Usar mi ubicaci√≥n para rutas">üìç GPS</button>
      </div>
      <div class="muted" style="margin-top:6px;">Vac√≠a <b>Provincia</b> para buscar en todo el pa√≠s. El buscador tolera plurales, acentos y espacios: <i>ferreterias</i> ‚âà <i>ferreter√≠a</i>, <i>super mercado</i> ‚âà <i>supermercado</i>, etc.</div>
    </div>

    <!-- Mapa arriba, lista debajo -->
    <div class="grid" style="grid-template-columns: 1fr; margin-top:10px;">
      <div class="card"><div id="map"></div></div>
      <details id="resPanel" class="results" open>
        <summary>
          <div class="summary-right">
            <span class="badge">Resultados: <span id="statCount">0</span></span>
            <span class="badge">Fuente: OpenStreetMap</span>
          </div>
          <span class="muted" style="display:flex; align-items:center; gap:6px;">Lista <span class="caret">‚ñ∂</span></span>
        </summary>
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Nombre</th><th>Tipo</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Web</th><th>Marca</th><th>Operador</th><th>Horario</th><th>Ruta</th><th>Registrar</th><th>Lat</th><th>Lon</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    
  <!-- Modal formulario de visita -->
  <div id="visitModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(2,6,23,.45); z-index:9999; align-items:center; justify-content:center; padding:10px;">
    <div class="card" style="width:min(920px,98vw); max-height:92vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
        <h3 style="margin:0">Registro de cliente / visita</h3>
        <button class="btn" onclick="closeVisitForm()">‚úñ</button>
      </div>
      <div class="muted" style="margin-bottom:8px;">Los campos del negocio se rellenan autom√°ticamente cuando usas el bot√≥n <b>Registrar</b> en la tabla.</div>
      <form id="visitForm" onsubmit="saveVisit(event)">
        <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          <div class="card" style="padding:10px;">
            <h4 style="margin:0 0 6px">Datos del negocio</h4>
            <label class="muted">Nombre</label>
            <input id="vf_name" required />
            <label class="muted">Tipo</label>
            <input id="vf_tipo"/>
            <label class="muted">Direcci√≥n</label>
            <input id="vf_address"/>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
              <div>
                <label class="muted">Provincia</label>
                <input id="vf_provincia"/>
              </div>
              <div>
                <label class="muted">Municipio</label>
                <input id="vf_municipio"/>
              </div>
            </div>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
              <div>
                <label class="muted">Latitud</label>
                <input id="vf_lat"/>
              </div>
              <div>
                <label class="muted">Longitud</label>
                <input id="vf_lon"/>
              </div>
            </div>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
              <div>
                <label class="muted">Tel√©fono</label>
                <input id="vf_phone"/>
              </div>
              <div>
                <label class="muted">Web</label>
                <input id="vf_website"/>
              </div>
            </div>
          </div>
          <div class="card" style="padding:10px;">
            <h4 style="margin:0 0 6px">Informaci√≥n de la visita</h4>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
              <div>
                <label class="muted">Fecha</label>
                <input id="vf_fecha" type="datetime-local" required/>
              </div>
              <div>
                <label class="muted">Estado</label>
                <select id="vf_estado">
                  <option>Prospecto</option>
                  <option>Interesado</option>
                  <option>Seguimiento</option>
                  <option>Cerrado</option>
                  <option>No interesado</option>
                </select>
              </div>
            </div>
            <label class="muted">Nombre del encargado</label>
            <input id="vf_encargado"/>
            <label class="muted">Tel√©fono del encargado</label>
            <input id="vf_tel_encargado"/>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
              <div>
                <label class="muted">D√≠as que atienden</label>
                <input id="vf_dias" placeholder="Lun-Vie, S√°b‚Ä¶"/>
              </div>
              <div>
                <label class="muted">Horario</label>
                <input id="vf_horario" placeholder="8:00‚Äì18:00"/>
              </div>
            </div>
            <label class="muted">Necesidades</label>
            <textarea id="vf_necesidades" style="min-height:70px;"></textarea>
            <label class="muted">Comentarios</label>
            <textarea id="vf_notas" style="min-height:70px;"></textarea>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; margin-top:8px;">
              <button class="btn" type="button" onclick="closeVisitForm()">Cancelar</button>
              <button class="btn btn-primary" type="submit">üíæ Guardar</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Registros guardados -->
  <details id="visPanel" class="results" style="margin-top:12px;">
    <summary>
      <div class="summary-right">
        <span class="badge">Registros: <span id="visCount">0</span></span>
      </div>
      <span class="muted" style="display:flex; align-items:center; gap:6px;">Registros de clientes <span class="caret">‚ñ∂</span></span>
    </summary>
    <div class="table-wrap">
      <table id="visTbl">
        <thead>
          <tr>
            <th>Fecha</th><th>Nombre</th><th>Estado</th><th>Encargado</th><th>Tel√©fono</th><th>Provincia</th><th>Municipio</th><th>Necesidades</th><th>Notas</th><th>Lat</th><th>Lon</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex; gap:8px; padding:8px;">
      <button class="btn" onclick="exportVisitasCSV()">‚¨á Exportar CSV</button>
      <button class="btn" onclick="clearVisitas()">üóë Borrar todo</button>
    </div>
  </details>

</div>
  </div>
  <div id="err" class="errbar"></div><div id="ok" class="okbar"></div>

<script>
// ====== Datos administrativos ======
const PROVINCIAS=["Azua","Bahoruco","Barahona","Dajab√≥n","Distrito Nacional","Duarte","El Seibo","El√≠as Pi√±a","Espaillat","Hato Mayor","Hermanas Mirabal","Independencia","La Altagracia","La Romana","La Vega","Mar√≠a Trinidad S√°nchez","Monse√±or Nouel","Monte Cristi","Monte Plata","Pedernales","Peravia","Puerto Plata","Saman√°","San Crist√≥bal","San Jos√© de Ocoa","San Juan","San Pedro de Macor√≠s","S√°nchez Ram√≠rez","Santiago","Santiago Rodr√≠guez","Santo Domingo","Valverde"];
const MUNICIPIOS={"Azua":["Azua de Compostela","Esteban√≠a","Guayabal","Las Charcas","Las Yayas de Viajama","Padre Las Casas","Peralta","Pueblo Viejo","Sabana Yegua","T√°bara Arriba"],"Bahoruco":["Neiba","Galv√°n","Los R√≠os","Tamayo","Villa Jaragua"],"Barahona":["Barahona","Cabral","El Pe√±√≥n","Enriquillo","Fundaci√≥n","Jaquimeyes","La Ci√©naga","Las Salinas","Para√≠so","Polo","Vicente Noble"],"Dajab√≥n":["Dajab√≥n","El Pino","Loma de Cabrera","Partido","Restauraci√≥n"],"Distrito Nacional":["Santo Domingo de Guzm√°n"],"Duarte":["San Francisco de Macor√≠s","Arenoso","Castillo","Eugenio Mar√≠a de Hostos","Las Gu√°ranas","Pimentel","Villa Riva"],"El Seibo":["Santa Cruz de El Seibo","Miches"],"El√≠as Pi√±a":["Comendador","B√°nica","El Llano","Hondo Valle","Juan Santiago","Pedro Santana"],"Espaillat":["Moca","Cayetano Germos√©n","Gaspar Hern√°ndez","Jamao al Norte"],"Hato Mayor":["Hato Mayor del Rey","El Valle","Sabana de la Mar"],"Hermanas Mirabal":["Salcedo","Tenares","Villa Tapia"],"Independencia":["Jiman√≠","Crist√≥bal","Duverg√©","La Descubierta","Mella","Postrer R√≠o"],"La Altagracia":["Salvale√≥n de Hig√ºey","San Rafael del Yuma"],"La Romana":["La Romana","Guaymate","Villa Hermosa"],"La Vega":["La Vega","Constanza","Jarabacoa","Jima Abajo"],"Mar√≠a Trinidad S√°nchez":["Nagua","Cabrera","El Factor","R√≠o San Juan"],"Monse√±or Nouel":["Bonao","Maim√≥n","Piedra Blanca"],"Monte Cristi":["San Fernando de Monte Cristi","Casta√±uelas","Guayub√≠n","Las Matas de Santa Cruz","Pepillo Salcedo","Villa V√°squez"],"Monte Plata":["Monte Plata","Bayaguana","Peralvillo","Sabana Grande de Boy√°","Yamas√°"],"Pedernales":["Pedernales","Oviedo"],"Peravia":["Ban√≠","Nizao"],"Puerto Plata":["San Felipe de Puerto Plata","Altamira","Guananico","Imbert","Los Hidalgos","Luper√≥n","Sos√∫a","Villa Isabela","Montellano"],"Saman√°":["Santa B√°rbara de Saman√°","S√°nchez","Las Terrenas"],"San Crist√≥bal":["San Crist√≥bal","Bajos de Haina","Cambita Garabitos","Los Cacaos","Sabana Grande de Palenque","San Gregorio de Nigua","Villa Altagracia","Yaguate"],"San Jos√© de Ocoa":["San Jos√© de Ocoa","Sabana Larga","Rancho Arriba"],"San Juan":["San Juan de la Maguana","Bohech√≠o","El Cercado","Juan de Herrera","Las Matas de Farf√°n","Vallejuelo"],"San Pedro de Macor√≠s":["San Pedro de Macor√≠s","Consuelo","Guayacanes","Quisqueya","Ram√≥n Santana","San Jos√© de los Llanos"],"S√°nchez Ram√≠rez":["Cotu√≠","Cevicos","Fantino","La Mata"],"Santiago":["Santiago de los Caballeros","Bison√≥ (Navarrete)","J√°nico","Licey al Medio","Pu√±al","Sabana Iglesia","San Jos√© de las Matas","Tamboril","Villa Gonz√°lez"],"Santiago Rodr√≠guez":["San Ignacio de Sabaneta","Los Alm√°cigos","Monci√≥n"],"Santo Domingo":["Santo Domingo Este","Santo Domingo Norte","Santo Domingo Oeste","Boca Chica","San Antonio de Guerra","Los Alcarrizos","Pedro Brand"],"Valverde":["Mao","Esperanza","Laguna Salada"]};

// ====== Sin√≥nimos ampliados ======
const KEYMAP={
 'constructoras':[{'k':'craft','v':'builder'},{'k':'office','v':'company'},{'k':'office','v':'architect'}],
 'constructora':[{'k':'craft','v':'builder'},{'k':'office','v':'company'},{'k':'office','v':'architect'}],
 'supermercado':[{'k':'shop','v':'supermarket'}],
 'super-mercado':[{'k':'shop','v':'supermarket'}],
 'super mercado':[{'k':'shop','v':'supermarket'}],
 'tienda de chinos':[{'k':'name','v':'chino'}],
 'tiendas de chinos':[{'k':'name','v':'chino'}],
 'concretera':[], 'concreteras':[],
 'ferreteria':[{'k':'shop','v':'hardware'},{'k':'shop','v':'doityourself'},{'k':'shop','v':'construction_supplies'},{'k':'shop','v':'trade'},{'k':'shop','v':'building_materials'}],
 'ferreter√≠a':[{'k':'shop','v':'hardware'},{'k':'shop','v':'doityourself'},{'k':'shop','v':'construction_supplies'},{'k':'shop','v':'trade'},{'k':'shop','v':'building_materials'}],
 'farmacia':[{'k':'amenity','v':'pharmacy'},{'k':'shop','v':'chemist'}],
 'gomeria':[{'k':'shop','v':'tyres'}],'gomera':[{'k':'shop','v':'tyres'}],
 'lavadero':[{'k':'amenity','v':'car_wash'}]
};

// ====== Claves texto libre muy amplias ======
const FREE_KEYS=["name","alt_name","short_name","official_name","brand","operator","description","shop","amenity","craft","office","tourism","leisure","healthcare","cuisine","man_made","industrial","sport","product","subject","building","landuse","highway","place","railway","waterway","natural","aeroway","boundary"];

// Amenidades gen√©ricas para ‚Äútodos‚Äù
const BUSINESS_AMENITIES=["bank","bar","cafe","car_rental","car_wash","clinic","dentist","doctor","fast_food","fuel","hairdresser","hospital","ice_cream","internet_cafe","optician","pharmacy","post_office","pub","restaurant","telecommunication","theatre","veterinary"];

// ====== Estado/Red ======
const OVERPASS=["https://lz4.overpass-api.de/api/interpreter","https://z.overpass-api.de/api/interpreter","https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.openstreetmap.fr/api/interpreter"];
const WRAPS=["https://r.jina.ai/http://","https://r.jina.ai/https://"];
const STATE={map:null,cluster:null,markers:[],feats:[],lastQL:'',server:'',me:null};

// ====== Utils ======
function showErr(m){const e=document.getElementById('err'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',6000);}
function showOk(m){const e=document.getElementById('ok'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',2000);}
function setStatus(t,p=null){document.getElementById('status').textContent=t; if(p!=null) document.getElementById('pbar').style.width=Math.min(100,Math.max(0,p))+'%';}
function setBusy(b){document.querySelectorAll('button,select,input').forEach(el=>el.disabled=!!b);}
function norm(s){return (s||'').toString().trim().toLowerCase();}
function strip(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function esc(s){return (s||'').replace(/[.*+?^${}()|[\\]\\]/g,'\\$&');}

// Mapa
function initMap(){ if(STATE.map) return; const RD=[18.735693,-70.162651]; STATE.map=L.map('map').setView(RD,8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(STATE.map); }
function ensureCluster(){ if(!STATE.cluster){ STATE.cluster=L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:50}); STATE.map.addLayer(STATE.cluster);} }
function clearMarkers(){ if(STATE.cluster){STATE.cluster.clearLayers();} (STATE.markers||[]).forEach(m=>{try{STATE.map.removeLayer(m);}catch{}}); STATE.markers=[]; }
function addMarker(lat,lon,props){ const m=L.marker([lat,lon]); const web=props.website?`<div>Web: <a class="a" href="${props.website}" target="_blank" rel="noopener">${props.website}</a></div>`:''; const tel=props.phone?`<div>Tel: ${props.phone}</div>`:''; const route=`<div><a class="a" href="#" onclick="routeTo(${lat},${lon});return false;">üß≠ C√≥mo llegar (Google)</a></div>`; m.bindPopup(`<strong>${props.name||'(sin nombre)'}</strong><div class="muted">${props.tipo||''}</div><div>${props.address||''}</div>${tel}${web}${route}`); STATE.markers.push(m); if(document.getElementById('cbCluster').checked){ensureCluster(); STATE.cluster.addLayer(m);} else m.addTo(STATE.map); }

// ====== Overpass QL builders ======
function header(){ return "[out:json][timeout:50];"; }
function areaCountry(){ return `${header()}area["ISO3166-1"="DO"]->.a; out ids bb;`; }
function areaByName(name){ const rx=esc(name); return `${header()}
area["ISO3166-1"="DO"]->.country;
rel(area.country)["boundary"="administrative"]["name"~"^${rx}$", i];
out ids bb;`; }
function blockOut(body, rapido){ const lim=rapido?' 300':''; return `(
${body}
);
out center${lim};`; }

// Regex con tolerancia
function accentFoldRegex(s){
  const map = {a:'[a√°√†√§√¢]', e:'[e√©√®√´√™]', i:'[i√≠√¨√Ø√Æ]', o:'[o√≥√≤√∂√¥]', u:'[u√∫√π√º√ª]', n:'[n√±]'};
  return s.split('').map(ch=>{
    const c=strip(ch);
    if(map[c]) return map[c];
    if(/[a-z0-9]/.test(c)) return c;
    return '.*';
  }).join('');
}
function makeRegexFromQuery(q){
  let base = strip(q.toLowerCase()).replace(/[^a-z0-9]+/g,' ').trim();
  if(!base) return '.*';
  const tokens = base.split(/\s+/);
  let core = tokens.map(t=>accentFoldRegex(t)).join('.*');
  core += '(e?s)?';
  if(/concret|hormigon|hormig|ready ?mix/.test(base)){ core = '(concret|hormig[o√≥]n|premezclad|ready ?mix)'; }
  if(/super ?mercad/.test(base)){ core = 'super[- ]?mercad'; }
  return core;
}

function byBBoxTagsOrName(q, tags, b, rapido){
  const s=b.minlat,w=b.minlon,n=b.maxlat,e=b.maxlon;
  const rx=makeRegexFromQuery(q);
  const parts=[];
  if(tags && tags.length){
    parts.push(tags.map(t=>`node["${t.k}"="${t.v}"](${s},${w},${n},${e}); way["${t.k}"="${t.v}"](${s},${w},${n},${e}); relation["${t.k}"="${t.v}"](${s},${w},${n},${e});`).join('\n'));
  }
  const free =
    [`node["name"~"${rx}",i](${s},${w},${n},${e});`,`way["name"~"${rx}",i](${s},${w},${n},${e});`,`relation["name"~"${rx}",i](${s},${w},${n},${e});`]
    .concat(FREE_KEYS.filter(key => key!=="name").map(key=>`node["${key}"~"${rx}", i](${s},${w},${n},${e}); way["${key}"~"${rx}", i](${s},${w},${n},${e}); relation["${key}"~"${rx}", i](${s},${w},${n},${e});`)).join('\n');
  parts.push(free);
  return header()+blockOut(parts.join('\n'),rapido);
}

function byBBoxNameOnly(q, b, rapido){
  const s=b.minlat,w=b.minlon,n=b.maxlat,e=b.maxlon;
  const rx=makeRegexFromQuery(q);
  const body=`node["name"~"${rx}", i](${s},${w},${n},${e});
way["name"~"${rx}", i](${s},${w},${n},${e});
relation["name"~"${rx}", i](${s},${w},${n},${e});`;
  return header()+blockOut(body,rapido);
}

function byBBoxAnyTag(q,b,rapido){
  const s=b.minlat,w=b.minlon,n=b.maxlat,e=b.maxlon;
  const rx=makeRegexFromQuery(q);
  const KEY_RE='^(name|alt_name|short_name|official_name|brand|operator|description|shop|amenity|craft|office|tourism|leisure|healthcare|cuisine|man_made|industrial|sport|product|subject|building|landuse|aeroway|aerialway|barrier|boundary|highway|historic|internet_access|place|public_transport|railway|route|waterway|natural|emergency|education|historic|heritage|payment:.*|contact:.*)$';
  const body=[
    `node(${s},${w},${n},${e})[~"${KEY_RE}"~"${rx}", i];`,
    `way(${s},${w},${n},${e})[~"${KEY_RE}"~"${rx}", i];`,
    `relation(${s},${w},${n},${e})[~"${KEY_RE}"~"${rx}", i];`
  ].join('\n');
  return header()+blockOut(body,rapido);
}
function byBBoxWideKeys(q,b,rapido){
  const s=b.minlat,w=b.minlon,n=b.maxlat,e=b.maxlon;
  const rx=makeRegexFromQuery(q);
  const KEYS=['shop','amenity','craft','office','industrial','man_made','building','landuse'];
  const body=KEYS.map(key=>`node["${key}"]["name"~"${rx}", i](${s},${w},${n},${e}); way["${key}"]["name"~"${rx}", i](${s},${w},${n},${e}); relation["${key}"]["name"~"${rx}", i](${s},${w},${n},${e});`).join('\n');
  return header()+blockOut(body,rapido);
}

function byBBoxAll(b,rapido){
  const s=b.minlat,w=b.minlon,n=b.maxlat,e=b.maxlon;
  const amen=BUSINESS_AMENITIES.map(v=>`node["amenity"="${v}"](${s},${w},${n},${e}); way["amenity"="${v}"](${s},${w},${n},${e}); relation["amenity"="${v}"](${s},${w},${n},${e});`).join('\n');
  const shops=`node["shop"](${s},${w},${n},${e}); way["shop"](${s},${w},${n},${e}); relation["shop"](${s},${w},${n},${e});`;
  const office=`node["office"](${s},${w},${n},${e}); way["office"](${s},${w},${n},${e}); relation["office"](${s},${w},${n},${e});`;
  return header()+blockOut(amen+'\n'+shops+'\n'+office,rapido);
}

function aroundTagsOrName(q,tags,c,r,rapido){
  const rx=makeRegexFromQuery(q);
  const parts=[];
  if(tags && tags.length){
    parts.push(tags.map(t=>`node(around:${r},${c.lat},${c.lon})["${t.k}"="${t.v}"]; way(around:${r},${c.lat},${c.lon})["${t.k}"="${t.v}"]; relation(around:${r},${c.lat},${c.lon})["${t.k}"="${t.v}"];`).join('\n'));
  }
  const free = [`node(around:${r},${c.lat},${c.lon})["name"~"${rx}",i];`,`way(around:${r},${c.lat},${c.lon})["name"~"${rx}",i];`,`relation(around:${r},${c.lat},${c.lon})["name"~"${rx}",i];`]
    .concat(FREE_KEYS.filter(key => key!=="name").map(key=>`node(around:${r},${c.lat},${c.lon})["${key}"~"${rx}", i]; way(around:${r},${c.lat},${c.lon})["${key}"~"${rx}", i]; relation(around:${r},${c.lat},${c.lon})["${key}"~"${rx}", i];`)).join('\n');
  parts.push(free);
  return header()+blockOut(parts.join('\n'),rapido);
}

// Helpers bbox
function expandBBox(b, pad=0.28){return {minlat:b.minlat-pad, minlon:b.minlon-pad, maxlat:b.maxlat+pad, maxlon:b.maxlon+pad};}
function centerOf(b){return {lat:(b.minlat+b.maxlat)/2, lon:(b.minlon+b.maxlon)/2};}

// ====== Transformaci√≥n/tabla ======
function usableCount(json){let c=0;const els=(json&&json.elements)||[];for(const el of els){const lat=el.lat||(el.center&&el.center.lat);const lon=el.lon||(el.center&&el.center.lon);if(lat!=null&&lon!=null)c++;}return c;}
function pushResults(json){
  const telReq=document.getElementById('cbTel').checked;
  const webReq=document.getElementById('cbWeb').checked;
  const els=(json&&json.elements)||[];
  for(const el of els){
    const lat=el.lat||(el.center&&el.center.lat);
    const lon=el.lon||(el.center&&el.center.lon);
    if(lat==null||lon==null) continue;
    const t=el.tags||{};
    const phone=t['phone']||t['contact:phone']||'';
    const website=t['website']||t['contact:website']||'';
    if(telReq && !phone) continue;
    if(webReq && !website) continue;
    STATE.feats.push({
      name:t.name||'', tipo:t.shop||t.amenity||t.craft||t.office||t.tourism||t.leisure||t.healthcare||'',
      address:[t['addr:street'],t['addr:housenumber']].filter(Boolean).join(' ')||t['addr:full']||'',
      phone, website, brand:t.brand||'', operator:t.operator||'', hours:t.opening_hours||'',
      lat:+lat, lon:+lon
    });
  }
}


// ====== Helpers de red gen√©ricos (con fallback CORS-free) ======
async function fetchJSONTry(urls){
  let last=null;
  for(const u of urls){
    try{
      const r=await fetch(u,{headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }catch(e){ last=e; }
  }
  throw last||new Error('fetch failed');
}
// ====== Taginfo (sugerencias de etiquetas) ======
async function taginfoSuggest(term){
  const q=encodeURIComponent(term);
  const urls=[
    `https://taginfo.openstreetmap.org/api/4/search/by_keyword?query=${q}&lang=es`,
    `https://r.jina.ai/http://taginfo.openstreetmap.org/api/4/search/by_keyword?query=${q}&lang=es`,
    `https://r.jina.ai/https://taginfo.openstreetmap.org/api/4/search/by_keyword?query=${q}&lang=es`
  ];
  try{
    const data=await fetchJSONTry(urls);
    const out=[];
    if(data && data.results){
      for(const r of data.results){
        if(r.key){
          if(r.value){ out.push({k:r.key, v:r.value}); }
          // si solo hay key, lo usamos luego como b√∫squeda libre en esa clave
        }
      }
    }
    // deduplicar y cortar
    const seen=new Set(); const uniq=[];
    for(const t of out){
      const id=`${t.k}=${t.v}`;
      if(!seen.has(id)){ seen.add(id); uniq.push(t); }
      if(uniq.length>=8) break;
    }
    return uniq;
  }catch(e){ return []; }
}
// ====== Nominatim (texto libre) ======
async function nominatimSearch(term, bbox, prov){
  const q=[term, prov||'Rep√∫blica Dominicana'].filter(Boolean).join(' ');
  const params = new URLSearchParams({
    format:'json',
    q,
    countrycodes:'do',
    limit:'80',
    addressdetails:'1',
  });
  // bias por bbox si lo tenemos
  if(bbox){
    params.set('viewbox', `${bbox.minlon},${bbox.maxlat},${bbox.maxlon},${bbox.minlat}`);
    params.set('bounded','1');
  }
  const base=`https://nominatim.openstreetmap.org/search?${params.toString()}`;
  const urls=[
    base,
    'https://r.jina.ai/'+base.replace(/^https?:\/\//,'')
  ];
  try{
    const data=await fetchJSONTry(urls);
    return Array.isArray(data)?data:[];
  }catch(e){ return []; }
}
function pushNominatim(results){
  for(const r of results){
    const lat=+r.lat, lon=+r.lon; if(!lat||!lon) continue;
    const name=r.name||r.display_name||'(sin nombre)';
    const tipo=r.type||r.class||'';
    STATE.feats.push({
      name, tipo,
      address:r.display_name||'',
      phone:'', website:'', brand:'', operator:'', hours:'',
      lat, lon
    });
  }
}

// ====== Red ======
async function fetchAny(u){ const r=await fetch(u,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('HTTP '+r.status); const txt=await r.text(); try{return JSON.parse(txt);}catch{throw new Error('No JSON');} }
async function overpassAll(ql){
  const short='?data='+encodeURIComponent(ql);
  const primary=OVERPASS.map(b=>b+short);
  const wrapped=[]; for(const w of WRAPS){ for(const b of OVERPASS){ wrapped.push(w+b.replace(/^https?:\/\//,'')+short);} }
  const all=primary.concat(wrapped);
  let last=null;
  for(const u of all){ try{ const data=await fetchAny(u); STATE.server=u; return data; }catch(e){ last=e; } }
  throw last||new Error('Overpass unreachable');
}

// ====== BBoxes ======
const FALLBACK_RD_BBOX={minlat:17.50, minlon:-72.00, maxlat:20.05, maxlon:-68.20}; // RD
async function getCountryBBox(){
  try{
    const d=await overpassAll(areaCountry());
    if(d && d.bounds) return d.bounds;
    if(d && d.elements && d.elements[0] && d.elements[0].bounds) return d.elements[0].bounds;
  }catch(e){ /* ignore */ }
  return FALLBACK_RD_BBOX;
}
async function getBBox(name){
  const q=areaByName(name);
  try{
    const d=await overpassAll(q);
    if(d && d.bounds) return d.bounds;
    if(d && d.elements && d.elements[0] && d.elements[0].bounds) return d.elements[0].bounds;
  }catch(e){ /* ignore */ }
  return null;
}

// ====== Rutas (Google Maps siempre) ======
function enableGPS(){
  if(!navigator.geolocation){ showErr('GPS no disponible en este navegador.'); return; }
  navigator.geolocation.getCurrentPosition(p=>{ STATE.me={lat:p.coords.latitude, lon:p.coords.longitude}; showOk('GPS activado'); }, _=>showErr('No se pudo obtener ubicaci√≥n'), {enableHighAccuracy:true, timeout:8000});
}
async function routeTo(lat,lon){
  const url=`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
  window.open(url,'_blank','noopener');
}
window.routeTo=routeTo;


// ====== Registro de visitas (localStorage) ======
function openVisitFormFromRow(obj){
  const p=document.getElementById('selProv').value||'';
  const m=document.getElementById('selMuni').value||'';
  openVisitForm({
    name:obj.name||'', tipo:obj.tipo||'', address:obj.address||'', phone:obj.phone||'', website:obj.website||'',
    lat:obj.lat||'', lon:obj.lon||'', provincia:p, municipio:m
  });
}
function openVisitForm(prefill){
  document.getElementById('visitModal').style.display='flex';
  const now=new Date(); const iso= new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  document.getElementById('vf_fecha').value = iso;
  document.getElementById('vf_name').value = prefill?.name||'';
  document.getElementById('vf_tipo').value = prefill?.tipo||'';
  document.getElementById('vf_address').value = prefill?.address||'';
  document.getElementById('vf_provincia').value = prefill?.provincia||document.getElementById('selProv').value||'';
  document.getElementById('vf_municipio').value = prefill?.municipio||document.getElementById('selMuni').value||'';
  document.getElementById('vf_lat').value = prefill?.lat||'';
  document.getElementById('vf_lon').value = prefill?.lon||'';
  document.getElementById('vf_phone').value = prefill?.phone||'';
  document.getElementById('vf_website').value = prefill?.website||'';
}
function closeVisitForm(){ document.getElementById('visitModal').style.display='none'; }
function getVisitas(){ try{ return JSON.parse(localStorage.getItem('visitasRD')||'[]'); }catch{return [];} }
function setVisitas(arr){ localStorage.setItem('visitasRD', JSON.stringify(arr)); renderVisitas(); }
function saveVisit(ev){
  ev.preventDefault();
  const v={
    fecha:document.getElementById('vf_fecha').value,
    name:document.getElementById('vf_name').value.trim(),
    tipo:document.getElementById('vf_tipo').value.trim(),
    address:document.getElementById('vf_address').value.trim(),
    provincia:document.getElementById('vf_provincia').value.trim(),
    municipio:document.getElementById('vf_municipio').value.trim(),
    lat:document.getElementById('vf_lat').value.trim(),
    lon:document.getElementById('vf_lon').value.trim(),
    phone:document.getElementById('vf_phone').value.trim(),
    website:document.getElementById('vf_website').value.trim(),
    estado:document.getElementById('vf_estado').value,
    encargado:document.getElementById('vf_encargado').value.trim(),
    tel_encargado:document.getElementById('vf_tel_encargado').value.trim(),
    dias:document.getElementById('vf_dias').value.trim(),
    horario:document.getElementById('vf_horario').value.trim(),
    necesidades:document.getElementById('vf_necesidades').value.trim(),
    notas:document.getElementById('vf_notas').value.trim(),
  };
  const arr=getVisitas(); arr.unshift(v); setVisitas(arr);
  closeVisitForm(); showOk('Visita guardada');
}
function renderVisitas(){
  const arr=getVisitas();
  const tb=document.querySelector('#visTbl tbody'); if(!tb) return; tb.innerHTML='';
  arr.forEach(v=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${v.fecha||''}</td>
      <td>${v.name||''}</td>
      <td>${v.estado||''}</td>
      <td>${v.encargado||''}</td>
      <td>${v.tel_encargado||''}</td>
      <td>${v.provincia||''}</td>
      <td>${v.municipio||''}</td>
      <td>${(v.necesidades||'').slice(0,80)}</td>
      <td>${(v.notas||'').slice(0,80)}</td>
      <td>${v.lat||''}</td>
      <td>${v.lon||''}</td>`;
    tb.appendChild(tr);
  });
  const c=document.getElementById('visCount'); if(c) c.textContent=arr.length;
}
function exportVisitasCSV(){
  const arr=getVisitas(); if(!arr.length){ showErr('No hay registros'); return; }
  const headers=['fecha','name','tipo','address','provincia','municipio','lat','lon','phone','website','estado','encargado','tel_encargado','dias','horario','necesidades','notas'];
  const csv=[headers.join(',')].concat(arr.map(r=>headers.map(h=>{
    const v=(r[h]??'').toString(); return (/[",\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v);
  }).join(','))).join('\\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='visitas_clientes.csv'; a.click();
}
function clearVisitas(){ if(!confirm('¬øBorrar todos los registros?')) return; setVisitas([]); }


// ====== Flujo ======
document.addEventListener('DOMContentLoaded',()=>{
  initMap();
  const selP=document.getElementById('selProv'); selP.innerHTML='<option value="">(todo el pa√≠s)</option>'+PROVINCIAS.map(p=>`<option value="${p}">${p}</option>`).join('');
  selP.addEventListener('change',()=>{const l=MUNICIPIOS[selP.value]||[]; document.getElementById('selMuni').innerHTML='<option value="">(todos)</option>'+l.map(n=>`<option value="${n}">${n}</option>`).join('');});
  document.getElementById('btnBuscar').addEventListener('click',buscar);
  document.getElementById('btnCSV').addEventListener('click',()=>{ if(!STATE.feats.length) return showErr('No hay resultados.'); const headers=['name','tipo','address','phone','website','brand','operator','hours','lat','lon']; const csv=[headers.join(',')].concat(STATE.feats.map(r=>headers.map(h=>{const v=(r[h]??'').toString(); return (/[",\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v)}).join(','))).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='negocios_rd.csv'; a.click(); });
  document.getElementById('btnGPS').addEventListener('click', enableGPS);
  document.getElementById('btnGMaps').addEventListener('click', ()=>{
    const t=encodeURIComponent(document.getElementById('qTipo').value||'');
    const p=encodeURIComponent(document.getElementById('selMuni').value||document.getElementById('selProv').value||'Rep√∫blica Dominicana');
    const url=`https://www.google.com/maps/search/?api=1&query=${t}%20${p}`;
    window.open(url,'_blank','noopener');
  });
  document.getElementById('btnFormNuevo').addEventListener('click', ()=>openVisitForm({provincia:document.getElementById('selProv').value||'', municipio:document.getElementById('selMuni').value||''}));
  renderVisitas();
});

async function buscar(){
  const tipo=norm(document.getElementById('qTipo').value);
  const prov=document.getElementById('selProv').value;
  const muni=document.getElementById('selMuni').value||'';
  let rapido=document.getElementById('cbRapido').checked;
  if(!tipo) return showErr('Escriba un t√©rmino.');

  setBusy(true); setStatus('Obteniendo √°rea‚Ä¶',18); clearMarkers(); STATE.feats=[];

  try{
    let bbox=null;
    try{ if(muni) bbox=await getBBox(muni); }catch(e){ console.warn('bbox municipio',e); }
    if(!bbox && prov) bbox=await getBBox(prov);
    if(!bbox){ bbox=await getCountryBBox(); rapido=true; showOk('Buscando en todo el pa√≠s'); }

    const isAll=['todos','todo','negocios','*'].includes(tipo);
    const mapped=KEYMAP[norm(tipo)] || KEYMAP[strip(tipo)];
    let ql = isAll ? byBBoxAll(bbox,true) : byBBoxTagsOrName(tipo, mapped, bbox, rapido);

    setStatus('Consultando Overpass‚Ä¶',50);
    let data=await overpassAll(ql); let added=usableCount(data);

    if(!added){ ql = byBBoxAnyTag(tipo, bbox, true); setStatus('Cualquier clave‚Ä¶',62); data=await overpassAll(ql); added=usableCount(data); }
    if(!added){ ql = byBBoxNameOnly(tipo, bbox, true); setStatus('Nombre exacto/amplio‚Ä¶',74); data=await overpassAll(ql); added=usableCount(data); }
    if(!added){ ql = byBBoxWideKeys(tipo, bbox, true); setStatus('Claves t√≠picas‚Ä¶',80); data=await overpassAll(ql); added=usableCount(data); }
    if(!added){
      // Taginfo sugerencias -> Overpass
      setStatus('Taginfo (etiquetas)‚Ä¶',88);
      const sugg = await taginfoSuggest(tipo);
      if(sugg && sugg.length){
        ql = byBBoxTagsOrName(tipo, sugg, bbox, true);
        data = await overpassAll(ql); added=usableCount(data);
      }
    }
    if(!added){
      const c=centerOf(bbox); const r=prov?45000:70000;
      ql = aroundTagsOrName(tipo, mapped, c, r, true);
      setStatus('Barriendo por radio‚Ä¶',92);
      data=await overpassAll(ql); added=usableCount(data);
    }
    if(!added){
      // Nominatim texto libre (√∫ltimo recurso, gratis)
      setStatus('Nominatim (texto libre)‚Ä¶',96);
      const nomi = await nominatimSearch(tipo, bbox, prov);
      if(nomi && nomi.length){ pushNominatim(nomi); }
    }

    pushResults(data);

    const tb=document.querySelector('#tbl tbody'); tb.innerHTML=''; let bounds=[];
    STATE.feats.forEach((f,i)=>{
      const web = f.website ? `<a class="a" href="${f.website}" target="_blank" rel="noopener">${(function(u){try{return new URL(u).hostname}catch{return 'web'}})(f.website)}</a>` : '';
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${f.name||''}</td>
        <td>${f.tipo||''}</td>
        <td>${f.address||''}</td>
        <td>${f.phone||''}</td>
        <td>${web}</td>
        <td>${f.brand||''}</td>
        <td>${f.operator||''}</td>
        <td>${f.hours||''}</td>
        <td><button class="btn" onclick="routeTo(${f.lat},${f.lon})">Ruta</button></td>
        <td><button class="btn" onclick="openVisitFormFromRow(JSON.stringify({name:f.name||'',tipo:f.tipo||'',address:f.address||'',phone:f.phone||'',website:f.website||'',brand:f.brand||'',operator:f.operator||'',hours:f.hours||'',lat:f.lat,lon:f.lon}))">Registrar</button></td>
        <td>${f.lat.toFixed(6)}</td>
        <td>${f.lon.toFixed(6)}</td>`;
      tr.style.cursor='pointer'; tr.addEventListener('click',()=>STATE.map.setView([f.lat,f.lon],17));
      tb.appendChild(tr);
      addMarker(f.lat,f.lon,f); bounds.push([f.lat,f.lon]);
    });
    document.getElementById('statCount').textContent=STATE.feats.length;
    if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); }
    setStatus(STATE.feats.length?'Completado':'Sin datos en OSM para ese t√©rmino/√°rea.',100);
    if(!STATE.feats.length) showErr('Sin datos en OSM para ese t√©rmino/√°rea.'); else showOk('Listo');
  }catch(e){ console.error(e); showErr('Overpass/CORS: '+(e.message||e)); }
  finally{ setBusy(false); setTimeout(()=>{document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo';},900); }
}
</script>
</body>
</html>
