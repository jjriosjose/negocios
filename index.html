<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Negocios RD ‚Äì Buscador por Provincia/Municipio (v3)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <style>
    :root{ --bg:#f6f8fc; --card:#ffffff; --muted:#64748b; --text:#0b1220; --primary:#14b8a6; --border:#e5e9f2; --chip:#eef2f7; }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#f6f8fc 0%, #eef2f7 100%); color:var(--text);}
    .container{max-width:1200px; margin:0 auto; padding:16px;}
    .title{display:flex; align-items:center; gap:10px; margin:0 0 10px; }
    .badge{background:var(--chip); color:#475569; border:1px solid #e2e8f0; padding:3px 8px; border-radius:999px; font-size:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 6px 16px rgba(15,23,42,.06);}
    .muted{color:var(--muted); font-size:12px;}
    .grid{display:grid; gap:8px;}
    .grid-4{grid-template-columns: repeat(4, minmax(0, 1fr));}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    select,input[type="text"],button{width:100%; padding:10px; border-radius:12px; border:1px solid #d7dde8; background:#fff; color:var(--text); outline:none;}
    button{cursor:pointer; font-weight:600;}
    .btn{border:1px solid #dbe1ea; background:#ffffff;}
    .btn-primary{background: linear-gradient(135deg, #10b981, #14b8a6); border:0; color:#ffffff;}
    #map{width:100%; height:64vh; border-radius:14px; border:1px solid #dbe1ea; background:#eef2f7;}
    .table-wrap{max-height:60vh; overflow:auto; border-radius:12px; border:1px solid var(--border);}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th, td{padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; vertical-align:top;}
    th{position:sticky; top:0; background:#f4f7fb; color:#64748b; z-index:1;}
    .errbar,.okbar{position:fixed; left:8px; right:8px; bottom:8px; padding:8px 10px; border-radius:12px; display:none;}
    .errbar{background:#fde8e8; border:1px solid #f8b4b4; color:#7f1d1d;}
    .okbar{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;}
    .progress{height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid #e5e9f2;}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg,#10b981,#14b8a6); transition:width .25s;}
    .hint{font-size:12px; color:#64748b;}
    .link{color:#0ea5e9; text-decoration:none}
    .link:hover{text-decoration:underline}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .switch{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#334155}
    .switch input{vertical-align:middle}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">
      <h2 style="margin:0">Negocios RD</h2>
      <span class="badge">OSM + Overpass</span>
      <span class="badge">Single-file</span>
      <span class="badge">Listo para GitHub Pages</span>
    </div>

    <div class="card">
      <div class="grid grid-4">
        <div>
          <label class="muted">Tipo de negocio (buscador)</label>
          <input id="qTipo" type="text" placeholder="Ej.: ferreter√≠a, papeler√≠a, farmacia..." />
        </div>
        <div>
          <label class="muted">Provincia</label>
          <select id="selProv"></select>
        </div>
        <div>
          <label class="muted">Municipio (opcional)</label>
          <select id="selMuni"><option value="">(todos)</option></select>
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button id="btnBuscar" class="btn btn-primary" style="flex:1">üîé Buscar</button>
          <button id="btnCSV" class="btn" style="flex:1">‚¨á CSV</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="progress" style="flex:1; min-width:160px;"><div id="pbar"></div></div>
        <span id="status" class="hint">Listo</span>
        <button id="btnCargarMunicipios" class="btn">‚Üª Cargar municipios</button>
        <label class="switch"><input type="checkbox" id="cbCluster" checked> Clustering</label>
        <label class="switch"><input type="checkbox" id="cbRapido"> Modo r√°pido</label>
        <button id="btnShare" class="btn">üîó Copiar enlace</button>
      </div>
      <div class="hint" style="margin-top:6px;">Tip: si ‚ÄúMunicipio‚Äù tarda, d√©jalo vac√≠o y busca por provincia (m√°s r√°pido). El modo r√°pido limita la cantidad devuelta para responder antes.</div>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:10px;">
      <div class="card">
        <div id="map"></div>
        <div id="hintZero" class="hint" style="margin-top:6px; display:none;">Sin resultados para el √°rea seleccionada.</div>
      </div>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between; margin-bottom:6px;">
          <div class="badge">Resultados: <span id="statCount">0</span></div>
          <div class="badge">Fuente: OpenStreetMap (cobertura variable)</div>
        </div>
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Nombre</th><th>Tipo</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Web</th><th>Lat</th><th>Lon</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="err" class="errbar"></div>
  <div id="ok" class="okbar"></div>

<script>
const PROVINCIAS = [
  "Azua","Bahoruco","Barahona","Dajab√≥n","Distrito Nacional","Duarte","El√≠as Pi√±a","El Seibo","Espaillat",
  "Hato Mayor","Hermanas Mirabal","Independencia","La Altagracia","La Romana","La Vega","Mar√≠a Trinidad S√°nchez",
  "Monse√±or Nouel","Monte Cristi","Monte Plata","Pedernales","Peravia","Puerto Plata","Saman√°","San Crist√≥bal",
  "San Jos√© de Ocoa","San Juan","San Pedro de Macor√≠s","S√°nchez Ram√≠rez","Santiago","Santiago Rodr√≠guez",
  "Santo Domingo","Valverde"
];

const STATE = { map:null, cluster:null, markers:[], features:[], municipiosCache:{}, lastQuery:null };

function showErr(msg){const el=document.getElementById('err'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 4200);}
function showOk(msg){const el=document.getElementById('ok'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200);}
function setStatus(text, p=null){ document.getElementById('status').textContent=text; if(p!=null){ document.getElementById('pbar').style.width = Math.max(0, Math.min(100, p)) + '%'; } }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n'))?('\"'+s.replace(/\"/g,'\"\"')+'\"'):s; }
function toCSV(rows, headers){ const head=headers.map(csvEscape).join(','); const body=rows.map(r=>headers.map(h=>csvEscape(r[h])).join(',')).join('\\n'); return head+'\\n'+body; }
function uniq(arr){return Array.from(new Set(arr))}
function norm(s){return (s??'').toString().trim().toLowerCase();}
function stripAccents(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 75% 52%)`; }
function svgPin(color){ const fill=color||'#3b82f6'; const stroke='#0b1220'; const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38"><path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/><circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }

function initMap(){ if(STATE.map) return; const RD=[18.735693,-70.162651]; STATE.map=L.map('map',{zoomControl:true}).setView(RD,8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map); window.addEventListener('resize', ()=>STATE.map&&STATE.map.invalidateSize()); }
function clearMarkers(){ if(STATE.cluster){ STATE.cluster.clearLayers(); } STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function ensureCluster(){ if(!STATE.cluster){ STATE.cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 }); STATE.map.addLayer(STATE.cluster); } }

function addMarker(lat, lon, props){
  const color=hashColor(props.tipo||'negocio');
  const marker=L.marker([lat,lon],{icon: L.icon({iconUrl: svgPin(color), iconSize:[26,38], iconAnchor:[13,36], popupAnchor:[0,-30]})});
  let addr = [props.address, props.city, props.state].filter(Boolean).join(', ');
  const phone = props.phone ? `<div>Tel: ${props.phone}</div>` : '';
  const web = props.website ? `<div>Web: <a class="link" href="${props.website}" target="_blank" rel="noopener">${props.website}</a></div>` : '';
  marker.bindPopup(`<strong>${props.name||'(sin nombre)'}</strong><div class="muted">${props.tipo||''}</div><div>${addr||''}</div>${phone}${web}`);
  STATE.markers.push(marker);
  const useCluster = document.getElementById('cbCluster').checked;
  if(useCluster){ ensureCluster(); STATE.cluster.addLayer(marker); } else { marker.addTo(STATE.map); }
}

const OVERPASS_SERVERS = [
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.ru/api/interpreter",
  "https://overpass.openstreetmap.fr/api/interpreter"
];

// sin√≥nimos conocidos ‚Üí etiquetas OSM
const TAG_MAP = {
  'ferreteria': [{k:'shop', v:'hardware'}, {k:'shop', v:'doityourself'}, {k:'shop', v:'trade'}, {k:'shop', v:'construction_supplies'}],
  'ferreter√≠a': [{k:'shop', v:'hardware'}, {k:'shop', v:'doityourself'}, {k:'shop', v:'trade'}, {k:'shop', v:'construction_supplies'}],
  'papeleria': [{k:'shop', v:'stationery'}, {k:'shop', v:'office_supplies'}],
  'papeler√≠a': [{k:'shop', v:'stationery'}, {k:'shop', v:'office_supplies'}],
  'farmacia': [{k:'amenity', v:'pharmacy'}, {k:'shop', v:'chemist'}],
  'supermercado': [{k:'shop', v:'supermarket'}],
  'banco': [{k:'amenity', v:'bank'}],
  'restaurante': [{k:'amenity', v:'restaurant'}],
  'colmadon': [{k:'shop', v:'convenience'}],
  'colmado': [{k:'shop', v:'convenience'}],
  'ferreteria industrial': [{k:'shop', v:'trade'}]
};

function buildAreaString(prov, muni){ return (muni? (muni+', '):'') + prov + ', Dominican Republic'; }

function buildQuery(q, prov, muni, modoRapido){
  const kw = stripAccents(norm(q));
  const tags = TAG_MAP[kw] || TAG_MAP[q] || null;
  const areaStr = buildAreaString(prov, muni);
  const outLimit = modoRapido ? ' 300' : ''; // limitar salida en modo r√°pido
  let body = '';
  if(tags){
    const parts = tags.map(t => `node(area.a)["${t.k}"="${t.v}"]; way(area.a)["${t.k}"="${t.v}"]; relation(area.a)["${t.k}"="${t.v}"];`).join('\\n');
    body = `{{geocodeArea:${areaStr}}}->.a; (${parts}) out center tags${outLimit};`;
  }else{
    const r = q.replace(/["']/g,'').trim();
    body = `{{geocodeArea:${areaStr}}}->.a;
      (
        node(area.a)["name"~"${r}", i];
        way(area.a)["name"~"${r}", i];
        relation(area.a)["name"~"${r}", i];
        node(area.a)["shop"~"${r}", i];
        way(area.a)["shop"~"${r}", i];
        relation(area.a)["shop"~"${r}", i];
        node(area.a)["amenity"~"${r}", i];
        way(area.a)["amenity"~"${r}", i];
        relation(area.a)["amenity"~"${r}", i];
      ); out center tags${outLimit};`;
  }
  return `[out:json][timeout:30];${body}`;
}

async function overpassFetch(query){
  // paralelo: dispara a 2 servidores a la vez, si falla intenta con el resto
  const batches = [
    [OVERPASS_SERVERS[0], OVERPASS_SERVERS[1]],
    [OVERPASS_SERVERS[2], OVERPASS_SERVERS[3]]
  ];
  let lastErr = null;
  for(const group of batches){
    try{
      const promises = group.map(url => {
        const ctl = new AbortController(); const id = setTimeout(()=>ctl.abort(), 18000);
        return fetch(url, {method:'POST', body: query, headers:{'Content-Type':'text/plain;charset=UTF-8'}, signal: ctl.signal})
          .then(r=>{ clearTimeout(id); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
      });
      const res = await Promise.any(promises);
      return res;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('Overpass error');
}

// Municipios con cach√© por provincia
async function cargarMunicipios(){
  const prov = document.getElementById('selProv').value;
  if(!prov){ showErr('Primero seleccione una provincia.'); return; }
  if(STATE.municipiosCache[prov]){
    llenarMunicipios(STATE.municipiosCache[prov]);
    showOk('Municipios desde cach√©');
    return;
  }
  setStatus('Buscando municipios‚Ä¶', 12);
  const areaStr = buildAreaString(prov, null);
  const q = `[out:json][timeout:25];
    {{geocodeArea:${areaStr}}}->.p;
    (
      rel(area.p)["boundary"="administrative"]["admin_level"~"^6|7|8$"]["name"];
      node(area.p)["place"~"city|town|village"]["name"];
    );
    out tags center;`;
  try{
    const data = await overpassFetch(q);
    const names = uniq((data.elements||[]).map(e => e.tags && e.tags.name).filter(Boolean));
    names.sort((a,b)=> String(a).localeCompare(String(b),'es',{numeric:true}));
    STATE.municipiosCache[prov] = names;
    llenarMunicipios(names);
    setStatus('Municipios cargados', 100); showOk('Municipios actualizados');
    setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 600);
  }catch(e){
    console.error(e); showErr('No se pudieron cargar municipios (Overpass). Pruebe buscar por provincia).');
    setStatus('Error al cargar municipios', 0);
  }
}

function llenarMunicipios(names){
  const sel = document.getElementById('selMuni');
  sel.innerHTML = '<option value="">(todos)</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
}

async function buscar(internal=false){
  initMap();
  const q = document.getElementById('qTipo').value.trim();
  const prov = document.getElementById('selProv').value;
  const muni = document.getElementById('selMuni').value || null;
  const modoRapido = document.getElementById('cbRapido').checked;
  if(!q){ showErr('Escriba el tipo de negocio a buscar.'); return; }
  if(!prov){ showErr('Seleccione una provincia.'); return; }

  setStatus('Consultando Overpass‚Ä¶', 25);
  const query = buildQuery(q, prov, muni, modoRapido);
  clearMarkers();
  document.querySelector('#tbl tbody').innerHTML = '';
  STATE.features = [];
  try{
    const data = await overpassFetch(query);
    const ok = procesarResultados(data);
    if(!ok && muni){
      // Fallback autom√°tico: si con municipio no hay datos, reintenta por provincia
      setStatus('Sin datos en municipio, probando provincia‚Ä¶', 40);
      const q2 = buildQuery(q, prov, null, modoRapido);
      const data2 = await overpassFetch(q2);
      const ok2 = procesarResultados(data2);
      if(ok2) showOk('Mostrando resultados a nivel provincia.');
    }
    setStatus('Completado', 100);
    setTimeout(()=>{ document.getElementById('pbar').style.width='0%'; document.getElementById('status').textContent='Listo'; }, 700);
    if(!internal) actualizarURL();
  }catch(e){
    console.error(e);
    showErr('Error consultando Overpass. Intente nuevamente o use otra provincia/municipio.');
    setStatus('Error', 0);
  }
}

function procesarResultados(data){
  const elements = (data && data.elements) ? data.elements : [];
  elements.forEach(el => {
    const lat = el.lat || (el.center && el.center.lat);
    const lon = el.lon || (el.center && el.center.lon);
    if(lat==null || lon==null) return;
    const t = el.tags || {};
    const tipo = t.shop || t.amenity || t.office || '';
    const feature = {
      name: t.name || '',
      tipo: tipo,
      address: [t['addr:street'], t['addr:housenumber']].filter(Boolean).join(' ') || t['addr:full'] || '',
      city: t['addr:city'] || t['is_in:city'] || '',
      state: t['addr:state'] || '',
      phone: t['phone'] || t['contact:phone'] || '',
      website: t['website'] || t['contact:website'] || '',
      lat: +lat, lon: +lon
    };
    STATE.features.push(feature);
  });
  renderResults();
  return STATE.features.length > 0;
}

function renderResults(){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  let bounds = [];
  const useCluster = document.getElementById('cbCluster').checked;
  if(useCluster) ensureCluster();
  STATE.features.forEach((f) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${f.name||''}</td>
      <td>${f.tipo||''}</td>
      <td>${[f.address,f.city,f.state].filter(Boolean).join(', ')}</td>
      <td>${f.phone||''}</td>
      <td>${f.website?`<a class="link" href="${f.website}" target="_blank" rel="noopener">link</a>`:''}</td>
      <td>${f.lat.toFixed(6)}</td>
      <td>${f.lon.toFixed(6)}</td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=>{ STATE.map.setView([f.lat, f.lon], 17); });
    tb.appendChild(tr);
    addMarker(f.lat, f.lon, f);
    bounds.push([f.lat, f.lon]);
  });
  document.getElementById('statCount').textContent = STATE.features.length;
  document.getElementById('hintZero').style.display = STATE.features.length ? 'none' : 'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); }
}

function exportCSV(){
  if(!STATE.features.length){ showErr('No hay resultados para exportar.'); return; }
  const headers = ['name','tipo','address','city','state','phone','website','lat','lon'];
  const csv = toCSV(STATE.features, headers);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'negocios_rd.csv'; a.click(); URL.revokeObjectURL(a.href);
}

function leerParams(){
  const u = new URL(location.href);
  return {
    tipo: u.searchParams.get('tipo') || '',
    prov: u.searchParams.get('prov') || '',
    muni: u.searchParams.get('muni') || '',
    rapido: u.searchParams.get('rapido') === '1',
    cluster: u.searchParams.get('cluster') !== '0'
  };
}
function actualizarURL(){
  const u = new URL(location.href);
  const tipo = document.getElementById('qTipo').value.trim();
  const prov = document.getElementById('selProv').value;
  const muni = document.getElementById('selMuni').value;
  const rapido = document.getElementById('cbRapido').checked ? '1' : '0';
  const cluster = document.getElementById('cbCluster').checked ? '1' : '0';
  u.searchParams.set('tipo', tipo);
  u.searchParams.set('prov', prov);
  u.searchParams.set('muni', muni);
  u.searchParams.set('rapido', rapido);
  u.searchParams.set('cluster', cluster);
  history.replaceState(null, '', u.toString());
}
function copiarEnlace(){
  actualizarURL();
  navigator.clipboard.writeText(location.href).then(()=> showOk('Enlace copiado')).catch(()=> showErr('No se pudo copiar el enlace.'));
}

async function init(){
  initMap();
  const selP = document.getElementById('selProv');
  selP.innerHTML = '<option value="">(seleccione)</option>' + PROVINCIAS.map(p=>`<option value="${p}">${p}</option>`).join('');
  document.getElementById('btnBuscar').addEventListener('click', ()=>buscar(false));
  document.getElementById('btnCSV').addEventListener('click', exportCSV);
  document.getElementById('btnCargarMunicipios').addEventListener('click', cargarMunicipios);
  document.getElementById('btnShare').addEventListener('click', copiarEnlace);

  // Cargar desde URL si hay par√°metros
  const p = leerParams();
  document.getElementById('qTipo').value = p.tipo || 'ferreter√≠a';
  if(p.cluster===false){ document.getElementById('cbCluster').checked = false; }
  document.getElementById('cbRapido').checked = !!p.rapido;
  if(PROVINCIAS.includes(p.prov)){ selP.value = p.prov; }
  if(selP.value){ await cargarMunicipios(); }
  const selM = document.getElementById('selMuni');
  if(p.muni){ selM.value = p.muni; }
  setStatus('Listo', 0);
  if(p.tipo && p.prov){ buscar(true); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
